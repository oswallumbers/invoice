<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .details-row {
            display: none; /* Hidden by default */
        }
        .main-row:hover {
            background-color: #f9fafb; /* Light gray on hover */
            cursor: pointer;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">

    <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Invoice Dashboard</h1>
                <p class="text-gray-600">Oswal Lumbers Pvt Ltd</p>
            </div>
            <div class="flex items-center gap-2 mt-4 sm:mt-0 flex-wrap">
                 <a href="https://oswallumbers.in/local_purchase/" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition-all">
                    <i class="fas fa-file-alt"></i> Compare Summary
                </a>
                <a href="performa-invoice.html" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition-all">
                    <i class="fas fa-file-alt"></i> New Performa Invoice
                </a>
                <a href="create-invoice.html" class="bg-pink-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-pink-700 transition-all">
                    <i class="fas fa-plus"></i> Create New Invoice
                </a>
                <a href="bulk.html" class="bg-pink-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-pink-700 transition-all">
                    <i class="fas fa-plus"></i> Bulk Inv
                </a>
                <button id="logoutBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 transition-all">
                    Logout
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div>
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Proforma Invoices</h2>
                <div class="bg-white rounded-2xl shadow-xl p-4 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Proforma No</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Buyer</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="performa-invoices-list" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div>
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Commercial Invoices</h2>
                <div class="bg-white rounded-2xl shadow-xl p-4 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Invoice No</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Buyer</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="commercial-invoices-list" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Balance Quantity Tracking</h2>
            <div class="bg-white rounded-2xl shadow-xl p-4 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Proforma No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Buyer</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total Qty (M3)</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Invoiced Qty (M3)</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Balance Qty (M3)</th>
                            </tr>
                        </thead>
                        <tbody id="balance-tracking-list" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

   <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="firebase-init.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('loggedIn') !== 'true') {
                window.location.href = 'export_invoice/login.html';
            }
            document.getElementById('logoutBtn').addEventListener('click', function() {
                sessionStorage.removeItem('loggedIn');
                window.location.href = 'https://oswallumbers.in/portal.html';
            });
            loadDashboardData();
        });

        async function loadDashboardData() {
            const performaList = document.getElementById('performa-invoices-list');
            const commercialList = document.getElementById('commercial-invoices-list');
            const balanceList = document.getElementById('balance-tracking-list');

            try {
                const performaPromise = db.collection('performaInvoices').orderBy('createdAt', 'desc').get();
                const commercialPromise = db.collection('invoices').orderBy('createdAt', 'desc').get();

                const [performaSnapshot, commercialSnapshot] = await Promise.all([performaPromise, commercialPromise]);

                const performaDataMap = new Map();
                performaSnapshot.forEach(doc => {
                    performaDataMap.set(doc.id, {
                        ...doc.data(),
                        id: doc.id,
                        invoicedM3: 0,
                        linkedInvoices: []
                    });
                });

                // पुराने commercialSnapshot.forEach लूप को इससे बदलें:

commercialSnapshot.forEach(doc => {
    const commercialData = { id: doc.id, ...doc.data() };
    
    // Logic 1: अगर नई 'performaAllocation' मौजूद है (Merged Invoice)
    if (commercialData.performaAllocation) {
        Object.keys(commercialData.performaAllocation).forEach(pId => {
            if (performaDataMap.has(pId)) {
                const performaEntry = performaDataMap.get(pId);
                // सटीक M3 जो इस PI से लिया गया है
                performaEntry.invoicedM3 += (commercialData.performaAllocation[pId] || 0);
                
                // डुप्लीकेट एंट्री से बचने के लिए चेक करें
                if (!performaEntry.linkedInvoices.some(inv => inv.id === commercialData.id)) {
                    performaEntry.linkedInvoices.push(commercialData);
                }
            }
        });
    } 
    // Logic 2: पुराना तरीका (Single PI के लिए, या पुराने डेटा के लिए)
    else if (commercialData.sourcePerformaId) {
        // अगर sourcePerformaId एक Array है (बिना allocation के)
        const sourceIds = Array.isArray(commercialData.sourcePerformaId) 
                          ? commercialData.sourcePerformaId 
                          : [commercialData.sourcePerformaId];
                          
        sourceIds.forEach(pId => {
            if (performaDataMap.has(pId)) {
                const performaEntry = performaDataMap.get(pId);
                // पुराने तरीके में हम मान लेते हैं कि पूरा totalM3 इसी PI का है
                // (Note: Merged invoices बिना allocation के यहाँ गलत बैलेंस दिखा सकते हैं, 
                // इसलिए getFormData में allocation save करना जरूरी है)
                performaEntry.invoicedM3 += (commercialData.totalM3 || 0);
                
                if (!performaEntry.linkedInvoices.some(inv => inv.id === commercialData.id)) {
                    performaEntry.linkedInvoices.push(commercialData);
                }
            }
        });
    }
});

                // Populate Proforma Invoices List
                performaList.innerHTML = '';
                if(performaSnapshot.empty) {
                    performaList.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">No Proforma Invoices.</td></tr>';
                } else {
                     performaSnapshot.forEach(doc => {
                        const data = doc.data();
                        const row = `
                            <tr>
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">${data.performaInvoiceNo}</td>
                                <td class="px-4 py-3 text-sm text-gray-600">${data.buyerName || 'N/A'}</td>
                                <td class="px-4 py-3 text-right text-sm font-medium">
                                    <button class="text-green-600 hover:text-green-900" onclick="downloadPerformaPDF('${doc.id}')" title="Download PDF"><i class="fas fa-file-pdf"></i></button>
                                    <button class="text-yellow-600 hover:text-yellow-900 ml-2" onclick="editPerformaInvoice('${doc.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                    <button class="text-red-600 hover:text-red-900 ml-2" onclick="deleteInvoice('${doc.id}', 'performaInvoices')" title="Delete"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>`;
                        performaList.innerHTML += row;
                    });
                }
               
                // Populate Commercial Invoices List
                commercialList.innerHTML = '';
                if(commercialSnapshot.empty) {
                    commercialList.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">No Commercial Invoices.</td></tr>';
                } else {
                    commercialSnapshot.forEach(doc => {
                        const data = doc.data();
                        const row = `
                            <tr>
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">${data.invoiceNo}</td>
                                <td class="px-4 py-3 text-sm text-gray-600">${data.buyerName || 'N/A'}</td>
                                <td class="px-4 py-3 text-right text-sm font-medium">
                                    <button class="text-blue-600 hover:text-blue-900" onclick="viewInvoice('${doc.id}')" title="View"><i class="fas fa-eye"></i></button>
                                    <button class="text-yellow-600 hover:text-yellow-900 ml-2" onclick="editInvoice('${doc.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                    <button class="text-red-600 hover:text-red-900 ml-2" onclick="deleteInvoice('${doc.id}', 'invoices')" title="Delete"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>`;
                        commercialList.innerHTML += row;
                    });
                }

                // Populate Balance Tracking List
                balanceList.innerHTML = '';
                if (performaDataMap.size === 0) {
                    balanceList.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No Proforma Invoices to track.</td></tr>';
                } else {
                    performaDataMap.forEach(data => {
                        const totalQty = data.totalM3 || 0;
                        const invoicedQty = data.invoicedM3;
                        const balanceQty = totalQty - invoicedQty;
                        
                        let balanceColor = balanceQty > 0.001 ? 'text-green-600' : (balanceQty < -0.001 ? 'text-red-600' : 'text-gray-800');
                        
                        let detailsHtml = '<div class="p-4 bg-gray-50 text-sm"><ul>';
                        if (data.linkedInvoices.length > 0) {
                            data.linkedInvoices.forEach(inv => {
                                const invDate = new Date(inv.invoiceDate).toLocaleDateString('en-GB');
                                detailsHtml += `<li class="py-1">Commercial Invoice <strong>${inv.invoiceNo}</strong> (Date: ${invDate}) - <strong>${(inv.totalM3 || 0).toFixed(3)} M3</strong></li>`;
                            });
                        } else {
                            detailsHtml += '<li>No commercial invoices generated yet.</li>';
                        }
                        detailsHtml += '</ul></div>';
                        
                        const rowHtml = `
                            <tr class="main-row" onclick="toggleDetails('${data.id}')">
                                <td class="px-6 py-4 text-gray-500"><i id="icon-${data.id}" class="fas fa-chevron-right"></i></td>
                                <td class="px-6 py-4 font-medium text-gray-900">${data.performaInvoiceNo}</td>
                                <td class="px-6 py-4 text-gray-600">${data.buyerName || 'N/A'}</td>
                                <td class="px-6 py-4 text-gray-600 text-right">${totalQty.toFixed(3)}</td>
                                <td class="px-6 py-4 text-gray-600 text-right">${invoicedQty.toFixed(3)}</td>
                                <td class="px-6 py-4 font-bold ${balanceColor} text-right">${balanceQty.toFixed(3)}</td>
                            </tr>
                            <tr id="details-${data.id}" class="details-row">
                                <td colspan="6">${detailsHtml}</td>
                            </tr>
                        `;
                        balanceList.innerHTML += rowHtml;
                    });
                }

            } catch (error) {
                console.error("Error loading dashboard data:", error);
                performaList.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-red-500">Error loading data.</td></tr>';
                commercialList.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-red-500">Error loading data.</td></tr>';
                balanceList.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-500">Error loading data.</td></tr>';
            }
        }
    
        // Function to toggle the visibility of the details row
        function toggleDetails(proformaId) {
            const detailsRow = document.getElementById(`details-${proformaId}`);
            const icon = document.getElementById(`icon-${proformaId}`);
            if (detailsRow.style.display === 'table-row') {
                detailsRow.style.display = 'none';
                icon.classList.replace('fa-chevron-down', 'fa-chevron-right');
            } else {
                detailsRow.style.display = 'table-row';
                icon.classList.replace('fa-chevron-right', 'fa-chevron-down');
            }
        }

        // --- Action Functions ---
        window.viewInvoice = (id) => { window.location.href = `view.html?id=${id}`; }
        window.editInvoice = (id) => { window.location.href = `create-invoice.html?id=${id}`; }
        window.editPerformaInvoice = (id) => { window.location.href = `performa-invoice.html?id=${id}`; }
    
        window.deleteInvoice = (id, collectionName) => {
            if (confirm(`Are you sure you want to delete this document?`)) {
                db.collection(collectionName).doc(id).delete().then(() => {
                    alert('Document deleted!');
                    location.reload();
                }).catch(error => console.error("Error removing document: ", error));
            }
        }
    
        window.downloadPerformaPDF = async (id) => {
            try {
                const docSnap = await db.collection('performaInvoices').doc(id).get();
                if (docSnap.exists) {
                    generatePerformaPDF(docSnap.data());
                } else { alert('Error: Performa Invoice not found.'); }
            } catch (error) {
                alert('Could not fetch Performa Invoice data.');
                console.error(error);
            }
        }
    
        // **CORRECTED PDF GENERATION FUNCTION FOR DASHBOARD**
        function generatePerformaPDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const font = 'Helvetica';
            doc.setFont(font, 'normal');
            const margin = 15;
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            let y = margin + 5;

            doc.setFontSize(30);
            doc.setFont(font, 'bold');
            doc.text('OSWAL LUMBERS PVT. LTD.', pageWidth / 2, y, { align: 'center' });
            y += 7;
            doc.setFontSize(11);
            doc.setFont(font, 'normal');
            doc.text('SURVEY NO 262, N H. 8/A, MITHIROHAR, GANDHIDHAM-370201-GUJARAT-INDIA', pageWidth / 2, y, { align: 'center' });
            y += 5;
            doc.text('E-MAIL: info@oswallumbers.com', pageWidth / 2, y, { align: 'center' });

            y += 10;
            const piDate = new Date(data.performaInvoiceDate).toLocaleDateString('en-GB');
            doc.setFont(font, 'bold');
            doc.text(`Sales Contract No: ${data.performaInvoiceNo}`, margin, y);
            doc.setFont(font, 'normal');
            doc.text(`Date: ${piDate}`, margin, y + 5);
            y += 20;

            doc.setFont(font, 'bold');
            doc.text('Buyer:', margin, y);
            y += 5;
            doc.setFont(font, 'normal');
            const fullBuyerText = data.buyerName + '\n' + data.buyerDetails;
            doc.text(fullBuyerText, margin, y, { maxWidth: 100 });
            y += (doc.getTextDimensions(fullBuyerText, { maxWidth: 100 }).h) + 10;
            
            doc.text('Dear Sir,', margin, y);
            y += 5;
            doc.text(`We are pleased to confirm having sold to you ${data.mainItemDesc}`, margin, y, { maxWidth: pageWidth - (margin * 2) });
            y += 10;
            
            const head = [['NO.', 'HSN', 'DIMENSION', 'QUANTITY ABOUT M3', 'CNF PRICE US$/M3', 'AMOUNT US$']];
            let body;

            if (data.groupItems && data.items.length > 0) {
                body = [];
                const totalM3 = data.items.reduce((sum, item) => sum + (parseFloat(item.m3) || 0), 0);
                const totalAmount = data.items.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
                const avgRate = totalM3 > 0 ? totalAmount / totalM3 : 0;
                const numItems = data.items.length;
                data.items.forEach((item, index) => {
                    const row = [item.sno, item.hsn, item.dimension];
                    if (index === 0) {
                        row.push({ content: totalM3.toFixed(3), rowSpan: numItems, styles: { valign: 'middle', halign: 'center' } });
                        row.push({ content: `$${avgRate.toFixed(2)}`, rowSpan: numItems, styles: { valign: 'middle', halign: 'center' } });
                        row.push({ content: `$${totalAmount.toFixed(2)}`, rowSpan: numItems, styles: { valign: 'middle', halign: 'center' } });
                    }
                    body.push(row);
                });
            } else {
                body = data.items.map(item => [
                    item.sno,
                    item.hsn,
                    item.dimension,
                    parseFloat(item.m3).toFixed(3),
                    `$${parseFloat(item.rate).toFixed(2)}`,
                    `$${parseFloat(item.amount).toFixed(2)}`
                ]);
            }

            doc.autoTable({
                head: head, body: body, startY: y, theme: 'grid',
                headStyles: { fontStyle: 'bold', halign: 'center' },
                styles: { fontSize: 9 },
            });
            y = doc.autoTable.previous.finalY + 10;

            const addTerm = (label, value) => {
                if (value) {
                    doc.setFont(font, 'bold');
                    doc.text(label, margin, y, { maxWidth: 40 });
                    doc.setFont(font, 'normal');
                    doc.text(value, margin + 45, y, { maxWidth: pageWidth - margin * 2 - 45 });
                    const textHeight = doc.getTextDimensions(value, { maxWidth: pageWidth - margin * 2 - 45 }).h;
                    y += textHeight + 4;
                }
            };

            addTerm('Shipment:', data.shipmentDetails);
            addTerm('Payment:', data.paymentTerms);
            addTerm('Freight:', data.freight);
            addTerm('Partial Shipment:', data.partialShipment);
            addTerm('Other Terms:', 'Invoice Packing List, BL & COO will be provided');
            
            y += 8;
            doc.setFont(font, 'bold');
            doc.text('Our Bank details:', margin, y);
            y += 5;
            doc.setFont(font, 'normal');
            
            const bankDetailsText = data.bankDetails;
            const bankDetailsDims = doc.getTextDimensions(bankDetailsText, { lineHeightFactor: 1.4, maxWidth: pageWidth - margin * 2 });
            doc.text(bankDetailsText, margin + 5, y, { lineHeightFactor: 1.4, maxWidth: pageWidth - margin * 2 });
            y += bankDetailsDims.h;

            if (data.calculationNote) {
                y += 10;
                doc.text(data.calculationNote, margin, y);
            }
            
            const signatureBlockHeight = 60; 
            if (y + signatureBlockHeight < pageHeight) {
                y = pageHeight - signatureBlockHeight - margin;
            } else {
                y += 15;
            }

            doc.setFont(font, 'normal');
            doc.text('Kindly stamp / Sign and return a copy as your acceptance.', margin, y);
            y += 10;

            doc.text('Best Regards,', margin, y);
            y += 15;

            doc.setFont(font, 'bold');
            doc.text('FOR, OSWAL LUMBERS PVT. LTD.', margin, y);
            y += 5;
            doc.text('DEEPAK PAREKH', margin, y);
            y += 5;
            doc.text('DIRECTOR', margin, y);

            doc.save(`Performa-Invoice-${data.performaInvoiceNo.replace(/\//g, '-')}.pdf`);
        }
    document.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('loggedIn') !== 'true') {
                window.location.href = 'login.html';
            }
            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.addEventListener('click', function() {
                sessionStorage.removeItem('loggedIn');
                window.location.href = 'login.html';
            });
        });

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
    
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates:true });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                try {
                    const invoiceData = parseExcelData(worksheet);
                    if (invoiceData) {
                        saveImportedInvoice(invoiceData);
                    }
                } catch (error) {
                    alert('Critical error parsing Excel file. Please ensure it matches the template format.\n\nError: ' + error.message);
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }
    
        function safeParseFloat(value) {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                const cleanedValue = value.replace(/[^0-9.-]+/g,"");
                return parseFloat(cleanedValue) || 0;
            }
            return 0;
        }
    
        function parseDate(excelDate) {
            if (!excelDate) return new Date().toISOString().split('T')[0];
            if (excelDate instanceof Date) {
                return excelDate.toISOString().split('T')[0];
            }
            const d = new Date(excelDate);
            if (!isNaN(d.getTime())) {
                return d.toISOString().split('T')[0];
            }
            console.warn("Unrecognized date format:", excelDate);
            return new Date().toISOString().split('T')[0];
        }
    
        function parseExcelData(ws) {
            const get = (addr) => ws[addr] ? ws[addr].v : '';
            
            const invoiceNo = get('H6');
            if (!invoiceNo) {
                alert('Parsing Error: Invoice Number not found in cell H6. Please check your file.');
                return null;
            }
    
            const sellerDetails = [get('A6'), get('A7'), get('A8'), get('A9'), get('A10'), get('A11'), get('A12')].filter(Boolean).join('\n');
            const buyerDetails = [get('A13'), get('A14'), get('A15'), get('A16')].filter(Boolean).join('\n');
            const invoiceDate = parseDate(get('H7'));
    
            const items = [];
            let totalAmount = 0;
            for (let i = 19; i < 28; i++) {
                const sno = get(`A${i}`);
                if (!sno) break; 
                
                const itemAmount = safeParseFloat(get(`H${i}`));
                items.push({
                    sno: sno,
                    desc: get(`B${i}`),
                    hsn: get(`C${i}`),
                    qty: safeParseFloat(get(`D${i}`)),
                    uom: get(`E${i}`),
                    m3: safeParseFloat(get(`F${i}`)),
                    rate: safeParseFloat(get(`G${i}`)),
                    amount: itemAmount
                });
                totalAmount += itemAmount;
            }
    
            return {
                sellerDetails: sellerDetails,
                buyerDetails: buyerDetails,
                invoiceNo: invoiceNo,
                invoiceDate: invoiceDate,
                terms: get('H8'),
                portLoading: get('H9'),
                portDischarge: get('H10'),
                countryOrigin: get('H11'),
                containerNo: get('A28') || '',
                containerSize: get('A29') || '',
                totalItems: get('A30') || '',
                grossWeight: get('A32') || '',
                netWeight: get('A33') || '',
                bankDetails: [get('E31'), get('E32'), get('E33'), get('E34')].filter(Boolean).join('\n'),
                remarks: '',
                totalAmount: totalAmount,
                items: items,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
        }
    
        async function saveImportedInvoice(invoiceData) {
            try {
                await db.collection('invoices').add(invoiceData);
                await updateInvoiceCounter(invoiceData.invoiceNo);
                alert(`Invoice ${invoiceData.invoiceNo} imported successfully!`);
                location.reload();
            } catch (error) {
                alert('Error saving the imported invoice.');
                console.error("Error adding document: ", error);
            }
        }
    
        async function updateInvoiceCounter(importedInvoiceNo) {
            const match = importedInvoiceNo.match(/EXP\/(\d+)\/\d+/);
            if (!match) return;
    
            const importedNumber = parseInt(match[1], 10);
            const settingsRef = db.collection('settings').doc('invoiceCounter');
    
            await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(settingsRef);
                const nextInvoiceNumber = doc.exists ? doc.data().nextInvoiceNumber : 1;
                
                if (importedNumber >= nextInvoiceNumber) {
                    transaction.set(settingsRef, { nextInvoiceNumber: importedNumber + 1 }, { merge: true });
                }
            });
        }
    </script>
</body>
</html>


