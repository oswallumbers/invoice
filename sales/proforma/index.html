<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oswal Lumbers PI System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, orderBy, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCMcudMEkqLZqhUYEgGKmyxBGb4udIVOGI",
            authDomain: "sales-department-12f46.firebaseapp.com",
            projectId: "sales-department-12f46",
            storageBucket: "sales-department-12f46.firebasestorage.app",
            messagingSenderId: "817643415284",
            appId: "1:817643415284:web:2a00ddd1046a6ec5cf60a1",
            measurementId: "G-7MSY9H9VGZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db; 
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.doc = doc;
        window.query = query;
        window.orderBy = orderBy;
        window.onSnapshot = onSnapshot;
        window.getDoc = getDoc;
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        /* App Font */
        body { font-family: 'Inter', sans-serif; }
        #invoice-preview-area {
            /* FIXED WIDTH: 208mm (Left room for border so it doesn't cut) */
            width: 208mm; 
            min-height: 297mm;
            padding: 10mm; 
            background-color: white;
            margin: 0 auto;
            border: 2px solid #000; /* Thicker border for PDF clarity */
            box-sizing: border-box; 
            position: relative;
        }
   @media print {
            /* 1. Reset Page Margins to avoid double margin issues */
            @page {
                size: A4;
                margin: 0; /* We will control margins via the container below */
            }

            /* 2. Hide everything else */
            body > * { display: none !important; }
            
            #print-modal { 
                display: block !important; 
                position: absolute !important; 
                left: 0 !important; 
                top: 0 !important; 
                width: 100% !important; 
                height: 100% !important; 
                background: white !important;
                z-index: 9999;
            }

            #print-modal * { visibility: visible !important; }
            
            /* 3. Invoice Container Adjustment */
            #invoice-preview-area {
                display: block !important;
                visibility: visible !important;
                position: absolute;
                
                /* KEEP LEFT AND TOP PERFECT */
                left: 5mm !important; 
                top: 5mm !important;
                
                /* FIX RIGHT MARGIN: 195mm ensures it stops before the right edge (210mm) */
                width: 195mm !important; 
                
                /* FIX BOTTOM MARGIN: Scale down to 90% to pull everything up */
                zoom: 90% !important; 
                
                border: 2px solid #000 !important; /* Thicker border for visibility */
                margin: 0 !important;
                padding: 5mm !important;
                box-shadow: none !important;
                
                /* Ensure it doesn't force a huge height */
                height: auto !important;
                min-height: auto !important;
            }

            /* Hide Buttons */
            .no-print, button { display: none !important; }
        }
        .print-only { display: none; }
        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-track { background: #f1f1f1; }
        .scroller::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* Custom Font Class for Numbers in Print View */
        .clean-digit {
            font-family: 'Arial', sans-serif !important;
            letter-spacing: 0.5px;
        }
        /*----------------------------------------------------*/
        .mobile-restriction {
        display: none;
    }

    /* 2. सिर्फ मोबाइल स्क्रीन के लिए नियम (768px से कम चौड़ाई) */
    @media only screen and (max-width: 768px) {
        
        /* पूरी वेबसाइट के बाकी कंटेंट को छुपा दें */
        body > *:not(.mobile-restriction) {
            display: none !important;
        }

        /* बॉडी का बैकग्राउंड सादा कर दें */
        body {
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            height: 100vh;
            overflow: hidden; /* स्क्रॉलिंग बंद करें */
        }

        /* मैसेज वाले बॉक्स को स्क्रीन पर दिखाएं */
        .mobile-restriction {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh; /* पूरी स्क्रीन घेर ले */
            width: 100%;
            text-align: center;
            background: #ffffff;
            z-index: 99999;
        }

        /* मैसेज की स्टाइलिंग (सजावट) */
        .message-box {
            border: 1px solid #ddd;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .message-box h1 {
            color: #d9534f; /* लाल रंग */
            font-size: 24px;
            margin-bottom: 10px;
        }

        .message-box p {
            color: #333;
            font-size: 16px;
        }
    }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
<div class="mobile-restriction">
    <div class="message-box">
        <h1>⚠️ Access Restricted</h1>
        <p>This website is optimized for Desktop only.</p>
        <p>Please open this link on a PC or Laptop to proceed.</p>
    </div>
</div>
    <div id="login-section" class="flex items-center justify-center h-screen bg-gradient-to-br from-blue-600 to-indigo-900">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 text-center">
             <button onclick="window.location.href='https://oswallumbers.in/portal.html'" class="text-gray-600 hover:text-blue-600 font-medium"><i class="fa-solid fa-house"></i> Go to Portal</button>
            <div class="mb-6">
                
                <i class="fa-solid fa-tree text-5xl text-blue-600"></i>
                <h2 class="text-2xl font-bold mt-2 text-gray-800">Oswal Lumbers</h2>
                <p class="text-gray-500 text-sm">PI Management System</p>
                
            </div>
            <input type="password" id="pin-input" placeholder="Enter PIN (1234)" class="w-full p-3 border rounded-lg mb-4 text-center text-xl tracking-widest focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="checkLogin()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">LOGIN</button>
            <p id="login-error" class="text-red-500 text-sm mt-2 hidden">Incorrect PIN</p>
        </div>
    </div>

    <div id="main-app" class="hidden">
        
        <nav class="bg-white shadow-md p-4 flex justify-between items-center no-print">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg"><i class="fa-solid fa-tree"></i></div>
                <h1 class="font-bold text-xl text-gray-800">Oswal Lumbers Pvt. Ltd.</h1>
            </div>
            <div class="flex gap-4">
                
                <button onclick="window.location.href='https://oswallumbers.in/portal.html'" class="text-gray-600 hover:text-blue-600 font-medium"><i class="fa-solid fa-house"></i> Go to Portal</button>
                <button onclick="showDashboard()" class="text-gray-600 hover:text-blue-600 font-medium"><i class="fa-solid fa-list"></i> Dashboard</button>
                <button onclick="createNewPI()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition"><i class="fa-solid fa-plus"></i> New PI</button>
                <button onclick="logout()" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </nav>

        <div id="dashboard-view" class="p-6 max-w-7xl mx-auto no-print">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 border-l-4 border-blue-600 pl-3">Proforma Invoice History</h2>
            <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                       <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
                            <tr>
                                <th class="p-4 border-b">PI Number</th>
                                <th class="p-4 border-b">Date</th>
                                <th class="p-4 border-b">Buyer Name</th>
                                <th class="p-4 border-b text-right">Qty</th>
                                <th class="p-4 border-b text-right">Amount</th>
                                <th class="p-4 border-b text-center">Status</th>
                                <th class="p-4 border-b">Start Date</th>
                                <th class="p-4 border-b">Close Date</th>
                                <th class="p-4 border-b">Period</th>
                                <th class="p-4 border-b text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-table-body" class="text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="form-view" class="hidden p-6 max-w-6xl mx-auto no-print">

            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Create / Edit Proforma Invoice</h2>
                <button onclick="showDashboard()" class="text-gray-500 hover:text-gray-700">Cancel</button>
            </div>

            <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-100">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">PI Number (Auto)</label>
                        <input type="text" id="inp-pi-no" class="w-full bg-gray-100 border rounded p-2 text-gray-500" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="date" id="inp-date" class="w-full border rounded p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Order No</label>
                        <input type="text" id="inp-order-no" placeholder="Enter Order No" class="w-full border rounded p-2">
                    </div>
                </div>

                <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-100 relative">
                    <div class="flex justify-between mb-2">
                        <h3 class="font-bold text-blue-800">Buyer Details</h3>
                        <button onclick="openBuyerModal()" class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700 flex items-center gap-2">
                            <i class="fa-solid fa-user-plus"></i> Add New / Select
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="inp-buyer-name" placeholder="Buyer Name" class="w-full border rounded p-2" readonly onclick="openBuyerModal()">
                        <input type="text" id="inp-gst" placeholder="GST Number" class="w-full border rounded p-2" readonly onclick="openBuyerModal()">
                        <textarea id="inp-address" placeholder="Address" class="w-full border rounded p-2 md:col-span-2" rows="2" readonly onclick="openBuyerModal()"></textarea>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="flex justify-between items-end mb-2">
                        <h3 class="font-bold text-gray-800">Item Details</h3>
                        <button onclick="addItemRow()" class="text-xs bg-gray-700 text-white px-3 py-1 rounded hover:bg-gray-900">+ Add Item</button>
                    </div>
                    <table class="w-full border text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="border p-2">Description</th>
                                <th class="border p-2 w-24">Qty (M2)</th>
                                <th class="border p-2 w-24">Price</th>
                                <th class="border p-2 w-32">Amount</th>
                                <th class="border p-2 w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="items-list">
                            </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="border p-2 text-right font-bold">GST @ 18%</td>
                                <td class="border p-2 bg-gray-50 text-right font-mono" id="disp-gst">0.00</td>
                                <td class="border bg-gray-50"></td>
                            </tr>
                            <tr>
                                <td colspan="3" class="border p-2 text-right font-bold text-lg">TOTAL</td>
                                <td class="border p-2 bg-blue-50 text-right font-bold font-mono text-lg" id="disp-total">0.00</td>
                                <td class="border bg-blue-50"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium mb-1">Shipment Period</label>
                        <input type="text" id="inp-shipment" value="DECEMBER 2025 / JANUARY 2026" class="w-full border rounded p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Payment Terms</label>
                        <input type="text" id="inp-payment" value="IRREVOCABLE L/C AT 90 DAYS" class="w-full border rounded p-2">
                    </div>
                </div>

                <div class="flex gap-4 mt-8">
                    <button onclick="saveInvoice()" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 shadow-lg">SAVE INVOICE</button>
                    <button onclick="previewInvoice()" class="flex-1 bg-gray-800 text-white py-3 rounded-lg font-bold hover:bg-gray-900 shadow-lg">PREVIEW & PRINT</button>
                </div>
            </div>
        </div>

        <div id="buyer-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center no-print">
            <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <div class="bg-blue-600 p-4 flex justify-between items-center text-white">
                    <h3 class="font-bold text-lg">Manage Buyers</h3>
                    <button onclick="closeBuyerModal()" class="hover:text-gray-200"><i class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div class="p-6 overflow-y-auto scroller">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-6">
                        <h4 class="font-bold text-blue-800 mb-3 text-sm uppercase">Add New Buyer</h4>
                        <div class="space-y-3">
                            <input type="text" id="new-buyer-name" placeholder="Buyer Company Name" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" id="new-buyer-gst" placeholder="GST Number" class="w-full border p-2 rounded outline-none">
                                <button onclick="saveNewBuyer()" class="bg-blue-600 text-white font-bold rounded hover:bg-blue-700 transition">Save & Select</button>
                            </div>
                            <textarea id="new-buyer-address" placeholder="Full Address" class="w-full border p-2 rounded outline-none" rows="2"></textarea>
                        </div>
                    </div>
                    <div id="buyer-list" class="space-y-2 mt-4"></div>
                </div>
            </div>
        </div>

        <div id="print-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center no-print">
            <div class="bg-white w-full max-w-4xl h-[90vh] overflow-y-auto p-4 rounded-lg relative">
                <button onclick="closePrint()" class="absolute top-4 right-4 bg-red-500 text-white w-8 h-8 rounded-full">X</button>
                
                <div class="flex gap-2 mb-4">
                    <button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded"><i class="fa-solid fa-print"></i> Print</button>
                    <button onclick="downloadPDF()" class="bg-green-600 text-white px-4 py-2 rounded"><i class="fa-solid fa-download"></i> PDF</button>
                </div>

                <div id="invoice-preview-area" class="bg-white p-6 border border-gray-300 mx-auto font-serif relative" style="width: 210mm; min-height: 297mm; color: black;">
                    
                    <div class="text-center border-b-2 border-blue-900 pb-2 mb-4">
                        <div class="flex justify-center items-center gap-4 mb-1">
                            <div class="w-14 h-14 rounded-full border-2 border-blue-900 flex items-center justify-center">
                                <i class="fa-solid fa-tree text-3xl text-red-600"></i>
                            </div>
                            <h1 class="text-3xl font-serif text-blue-900 font-bold uppercase tracking-wide">Oswal Lumbers Pvt. Ltd.</h1>
                        </div>
                        <p class="text-[10px] text-gray-600">SURVEY NO 262 N H 8/A MITHIROHAR GANDHIDHAM - 370201 - GUJARAT - INDIA</p>
                        <p class="text-[10px] text-gray-600">E-MAIL: info@oswallumbers.com</p>
                    </div>

                    <div class="flex justify-between items-center mb-6 border-b border-gray-300 pb-2">
                        <h2 class="text-lg font-bold">PROFORMA INVOICE NO. <span id="print-pi-no" class="clean-digit"></span></h2>
                        <div class="text-right text-sm font-bold">DATE: <span id="print-date-top" class="clean-digit"></span></div>
                    </div>

                  <div class="grid grid-cols-2 gap-4 text-xs mb-6">
                        <div>
                            <div class="flex mb-1 items-start">
                                <span class="w-24 font-bold shrink-0">BUYER:</span>
                                <div id="print-buyer-details" class="flex-1 uppercase font-bold"></div>
                            </div>
                            <div class="flex mb-1 mt-2 items-center">
                                <span class="w-24 font-bold shrink-0">GSTIN:</span>
                                <span id="print-gst" class="clean-digit font-bold"></span>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex mb-1 items-center">
                                <span class="w-36 font-bold shrink-0 whitespace-nowrap">ORDER NO:</span>
                                <span id="print-order-no" class="clean-digit font-bold"></span>
                            </div>
                            <div class="flex mb-1 items-center">
                                <span class="w-36 font-bold shrink-0 whitespace-nowrap">SHIPMENT PERIOD:</span>
                                <span id="print-shipment" class="uppercase font-bold"></span>
                            </div>
                            <div class="flex mb-1 items-center">
                                <span class="w-36 font-bold shrink-0 whitespace-nowrap">PAYMENT TERMS:</span>
                                <span id="print-payment" class="uppercase font-bold truncate"></span>
                            </div>
                            <div class="flex mb-1 items-center">
                                <span class="w-36 font-bold shrink-0 whitespace-nowrap">PLACE OF LOADING:</span>
                                <span class="uppercase font-bold">EX-WORKS GANDHIDHAM</span>
                            </div>
                            <div class="flex mb-1 items-center">
                                <span class="w-36 font-bold shrink-0 whitespace-nowrap">COUNTRY OF ORIGIN:</span>
                                <span class="uppercase font-bold">INDIA</span>
                            </div>
                        </div>
                    </div>

                    <table class="w-full border-2 border-blue-900 mb-4 text-xs">
                        <thead class="border-b-2 border-blue-900 bg-gray-100">
                            <tr>
                                <th class="border-r border-blue-900 p-2 text-center w-1/2">DESCRIPTION</th>
                                <th class="border-r border-blue-900 p-2 text-center">QUANTITY<br>M2</th>
                                <th class="border-r border-blue-900 p-2 text-center">PRICE<br>INR</th>
                                <th class="p-2 text-center">AMOUNT<br>INR</th>
                            </tr>
                        </thead>
                        <tbody id="print-items-body">
                            </tbody>
                        <tfoot class="border-t-2 border-blue-900 font-bold">
                            <tr>
                                <td class="border-r border-blue-900 p-2 text-right" colspan="3">GST @ 18%</td>
                                <td class="p-2 text-right clean-digit" id="print-gst-val"></td>
                            </tr>
                            <tr class="bg-gray-50 text-base">
                                <td class="border-r border-blue-900 p-2 text-right" colspan="3">TOTAL</td>
                                <td class="p-2 text-right clean-digit" id="print-grand-total"></td>
                            </tr>
                        </tfoot>
                    </table>

                    <div class="text-xs space-y-1 mb-6 leading-tight">
                        <p>1. LC SHOULD BE UNRESTRICTED AND FREELY NEGOTIABLE WITH ANY BANK IN INDIA.</p>
                        <p>2. +/- 5% IN BOTH QUANTITY AND AMOUNT ACCEPTABLE.</p>
                        <p>3. PARTIAL SHIPMENT PERMITTED.</p>
                        <p>4. TRANSHIPMENT PERMITTED.</p>
                        <p>5. ALL OPENING BANK CHARGES TO THE ACCOUNT OF APPLICANT.</p>
                        <p>6. ALL NEGOTIATING BANK CHARGES TO THE ACCOUNT OF THE BENEFICIARY.</p>
                        <p>7. QUALITY SPECIFICATIONS AS PER PURCHASE ORDER.</p>
                        <p>8. DELIVERY BEFORE LC OPENING DATE ACCEPTABLE.</p>
                    </div>

                    <div class="flex justify-between items-start mt-4">
                        <div class="w-1/2">
                            <p class="font-bold text-xs mb-1 underline">9. FIND BELOW OUR BANK DETAILS:</p>
                            <div class="text-[11px] ml-2 font-bold">
                                <p>ICICI BANK LTD.</p>
                                <p>IFSC: <span class="clean-digit">ICIC0000153</span></p>
                                <p>ARIHANT, PLOT NO. 341, WARD 12/B,</p>
                                <p>GANDHIDHAM - <span class="clean-digit">370 201</span>.</p>
                                <p>PIC: MR. RISHI MODI</p>
                                <p class="clean-digit lowercase">Email: rishi.modi@icicibank.com</p>
                                <p class="clean-digit">PH: 9687694880</p>
                            </div>
                        </div>
                        
                        <div class="text-center w-1/2 mt-40">
                             <div class="border-t border-gray-400 w-full mb-4"></div>
                             <p class="font-bold text-xs mb-10">FOR OSWAL LUMBERS PVT. LTD.</p>
                             <p class="font-bold text-[10px] border-t border-gray-800 pt-1 mt-2 inline-block">AUTHORISED SIGNATORY</p>
                        </div>
                    </div>
                    
                    <div class="text-center mt-8 text-[10px] text-gray-400 clean-digit">Page 1</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- AUTH LOGIC ---
        function checkLogin() {
            if (document.getElementById('pin-input').value === '1234') {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                loadDashboard();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }
        function logout() { location.reload(); }

        // --- NAVIGATION ---
        let currentDocId = null;

        function showDashboard() {
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('form-view').classList.add('hidden');
            document.getElementById('print-modal').classList.add('hidden');
            loadDashboard();
        }

        // --- ITEM ROWS LOGIC ---
        function addItemRow(data = {}) {
            const container = document.getElementById('items-list');
            const row = document.createElement('tr');
            row.className = 'item-row';
            row.innerHTML = `
                <td class="border p-2"><input type="text" class="inp-desc w-full outline-none" value="${data.desc || 'CORE VENEER 1.80 MM THICKNESS'}"></td>
                <td class="border p-2"><input type="number" class="inp-qty w-full outline-none text-right" value="${data.qty || ''}" oninput="calculateTotal()"></td>
                <td class="border p-2"><input type="number" class="inp-price w-full outline-none text-right" value="${data.price || ''}" oninput="calculateTotal()"></td>
                <td class="border p-2 bg-gray-50 text-right font-mono disp-row-amt">0.00</td>
                <td class="border p-2 text-center"><button onclick="this.closest('tr').remove(); calculateTotal()" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button></td>
            `;
            container.appendChild(row);
            calculateTotal();
        }

      // --- HELPER: Parse numbers with commas ---
        function parseIndian(str) {
            if(!str) return 0;
            // Remove commas and convert to float
            return parseFloat(str.toString().replace(/,/g, '')) || 0;
        }

        function calculateTotal() {
            let subtotal = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                // Use input values (which are plain numbers)
                const qty = parseFloat(row.querySelector('.inp-qty').value) || 0;
                const price = parseFloat(row.querySelector('.inp-price').value) || 0;
                const amt = qty * price;
                
                // Display with commas in the row
                row.querySelector('.disp-row-amt').innerText = formatIndian(amt);
                subtotal += amt;
            });

            const gst = subtotal * 0.18;
            const total = subtotal + gst;

            // Update footer displays
            document.getElementById('disp-gst').innerText = formatIndian(gst);
            document.getElementById('disp-total').innerText = formatIndian(total);
        }
        
        async function saveInvoice() {
            // Gather Items
            const items = [];
            document.querySelectorAll('.item-row').forEach(row => {
                items.push({
                    desc: row.querySelector('.inp-desc').value,
                    qty: parseFloat(row.querySelector('.inp-qty').value) || 0,
                    price: parseFloat(row.querySelector('.inp-price').value) || 0
                });
            });

            // Parse the Total text correctly (removing commas)
            const rawTotal = document.getElementById('disp-total').innerText;

            const piData = {
                piNo: document.getElementById('inp-pi-no').value,
                date: document.getElementById('inp-date').value,
                buyerName: document.getElementById('inp-buyer-name').value,
                buyerGst: document.getElementById('inp-gst').value,
                buyerAddress: document.getElementById('inp-address').value,
                orderNo: document.getElementById('inp-order-no').value,
                shipment: document.getElementById('inp-shipment').value,
                payment: document.getElementById('inp-payment').value,
                // Fix: Use parseIndian to save the correct number
                total: parseIndian(rawTotal), 
                items: items, 
                timestamp: new Date()
            };

            if(!currentDocId) piData.status = 'Pending';

            try {
                if(currentDocId) {
                    await window.updateDoc(window.doc(window.db, "invoices", currentDocId), piData);
                } else {
                    const ref = await window.addDoc(window.collection(window.db, "invoices"), piData);
                    currentDocId = ref.id;
                }
                alert('Saved Successfully');
            } catch (e) {
                console.error(e);
                alert('Error saving data: ' + e.message);
            }
        }
        // --- CRUD ---
      async function createNewPI() {
            currentDocId = null;
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('form-view').classList.remove('hidden');
            
            // Reset Form
            document.getElementById('inp-date').valueAsDate = new Date();
            document.getElementById('inp-buyer-name').value = '';
            document.getElementById('inp-gst').value = '';
            document.getElementById('inp-address').value = '';
            document.getElementById('inp-order-no').value = '';
            document.getElementById('items-list').innerHTML = '';
            addItemRow(); 

            try {
                const snap = await window.getDocs(window.collection(window.db, "invoices"));
                
                // --- AUTO GENERATE LOGIC ---
                // Start from 180 (Since 179 is manually done)
                const startOffset = 180; 
                const count = snap.size + startOffset;
                const year = new Date().getFullYear();
                
                // Format: OLPL/PI/180/2025
                document.getElementById('inp-pi-no').value = `OLPL/PI/${count}/${year}`;
                
            } catch (e) {
                console.error(e);
                document.getElementById('inp-pi-no').value = "OLPL/PI/ERROR";
            }
        }

        async function editInvoice(id) {
            currentDocId = id;
            const docSnap = await window.getDoc(window.doc(window.db, "invoices", id));
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('dashboard-view').classList.add('hidden');
                document.getElementById('form-view').classList.remove('hidden');

                document.getElementById('inp-pi-no').value = data.piNo;
                document.getElementById('inp-date').value = data.date;
                document.getElementById('inp-buyer-name').value = data.buyerName;
                document.getElementById('inp-gst').value = data.buyerGst;
                document.getElementById('inp-address').value = data.buyerAddress;
                document.getElementById('inp-order-no').value = data.orderNo || '';
                document.getElementById('inp-shipment').value = data.shipment;
                document.getElementById('inp-payment').value = data.payment;

                // Load Items (Handle old single-item data vs new multi-item data)
                const container = document.getElementById('items-list');
                container.innerHTML = '';
                if (data.items && data.items.length > 0) {
                    data.items.forEach(item => addItemRow(item));
                } else {
                    // Backwards compatibility for old records
                    addItemRow({ desc: data.desc, qty: data.qty, price: data.price });
                }
            }
        }

        

  function previewInvoice() {
            document.getElementById('print-pi-no').innerText = document.getElementById('inp-pi-no').value;
            
            const rawDate = document.getElementById('inp-date').value;
            const d = new Date(rawDate);
            document.getElementById('print-date-top').innerText = rawDate ? `${d.getDate()}.${d.getMonth()+1}.${d.getFullYear()}` : '';

            document.getElementById('print-buyer-details').innerHTML = 
                `${document.getElementById('inp-buyer-name').value}<br>` + 
                `${document.getElementById('inp-address').value.replace(/\n/g, '<br>')}`;
            
            document.getElementById('print-gst').innerText = document.getElementById('inp-gst').value;
            document.getElementById('print-order-no').innerText = document.getElementById('inp-order-no').value || '-';
            document.getElementById('print-shipment').innerText = document.getElementById('inp-shipment').value;
            document.getElementById('print-payment').innerText = document.getElementById('inp-payment').value;

            // --- RENDER ITEMS WITH SEPARATE GST ---
            const tbody = document.getElementById('print-items-body');
            tbody.innerHTML = '';
            
            let grandTotal = 0;
            let totalTax = 0;

            document.querySelectorAll('.item-row').forEach(row => {
                const desc = row.querySelector('.inp-desc').value;
                const qty = parseFloat(row.querySelector('.inp-qty').value) || 0;
                const price = parseFloat(row.querySelector('.inp-price').value) || 0;
                
                // Calculate Item Values
                const taxableAmt = qty * price;
                const gstAmt = taxableAmt * 0.18;
                
                totalTax += gstAmt;
                grandTotal += (taxableAmt + gstAmt);

                // Row 1: The Item
                tbody.innerHTML += `
                    <tr class="align-top">
                        <td class="border-r border-blue-900 p-2 uppercase font-bold">${desc}</td>
                        <td class="border-r border-blue-900 p-2 text-center clean-digit">${formatIndian(qty)}</td>
                        <td class="border-r border-blue-900 p-2 text-center clean-digit">${formatIndian(price)}</td>
                        <td class="p-2 text-right clean-digit font-bold">${formatIndian(taxableAmt)}</td>
                    </tr>
                `;

                // Row 2: The GST for this Item (Shown Separately)
                tbody.innerHTML += `
                    <tr class="align-top border-b border-blue-900 border-dashed text-gray-600 italic">
                        <td class="border-r border-blue-900 p-2 pl-8 text-xs">Add: GST @ 18%</td>
                        <td class="border-r border-blue-900 p-2"></td>
                        <td class="border-r border-blue-900 p-2"></td>
                        <td class="p-2 text-right clean-digit text-xs">${formatIndian(gstAmt)}</td>
                    </tr>
                `;
            });

            // Update Footer Totals
            // Note: Since we listed GST separately in the rows, the "Total" line implies the Sum.
            // But we keep the Summary block for clarity.
            
            document.getElementById('print-gst-val').innerText = formatIndian(totalTax);
            document.getElementById('print-grand-total').innerText = formatIndian(grandTotal);

            document.getElementById('print-modal').classList.remove('hidden');
        }
        function closePrint() { document.getElementById('print-modal').classList.add('hidden'); }
        
        function downloadPDF() {
            const element = document.getElementById('invoice-preview-area');
            html2pdf().set({ margin: 2, filename: `PI_${document.getElementById('inp-pi-no').value}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }).from(element).save();
        }

     async function updateStatus(id, newStatus, action) {
            // Confirm action
            const verb = action === 'undo' ? "Undo status to" : "Change status to";
            if(!confirm(`${verb} ${newStatus}?`)) return;

            const today = new Date().toISOString().split('T')[0];
            const updates = { status: newStatus };
            
            // Logic for Dates
            if (newStatus === 'Running') {
                if(action === 'undo') updates.closeDate = window.deleteField(); // Remove close date if undoing
                else updates.startDate = today;
            } 
            else if (newStatus === 'Closed') {
                updates.closeDate = today;
            } 
            else if (newStatus === 'Pending') {
                updates.startDate = window.deleteField(); // Remove start date if undoing
                updates.closeDate = window.deleteField();
            }
            
            try {
                // Need deleteField from Firestore
                const { deleteField } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                window.deleteField = deleteField; // ensure it's available
                
                await window.updateDoc(window.doc(window.db, "invoices", id), updates);
            } catch(e) {
                console.error(e);
                alert("Error updating status: " + e.message);
            }
        }
    // --- DASHBOARD ---
      function loadDashboard() {
            const tbody = document.getElementById('dashboard-table-body');
            // Update Header Row explicitly here or change your HTML <thead> to match these columns:
            // PI NO | DATE | BUYER | QTY | AMOUNT | STATUS | START | CLOSE | PERIOD | ACTIONS
            
            // NOTE: You should update your HTML <thead> to match these 10 columns for alignment
            
            tbody.innerHTML = '<tr><td colspan="10" class="text-center p-4">Loading...</td></tr>';
            
            const q = window.query(window.collection(window.db, "invoices"), window.orderBy("timestamp", "desc"));
            
            window.onSnapshot(q, (snapshot) => {
                tbody.innerHTML = '';
                if(snapshot.empty) { tbody.innerHTML = '<tr><td colspan="10" class="text-center p-4 text-gray-500">No Invoices Found</td></tr>'; return; }
                
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const id = docSnap.id;

                    // 1. Status Colors
                    let badgeColor = 'bg-gray-100 text-gray-800';
                    if(data.status === 'Pending') badgeColor = 'bg-yellow-100 text-yellow-800';
                    if(data.status === 'Running') badgeColor = 'bg-blue-100 text-blue-800';
                    if(data.status === 'Closed') badgeColor = 'bg-green-100 text-green-800';

                    // 2. Formatting Numbers
                    const fmtQty = data.items ? formatIndian(data.items.reduce((a, b) => a + (parseFloat(b.qty)||0), 0)) : formatIndian(data.qty || 0);
                    const fmtTotal = formatIndian(data.total);

                    // 3. Duration Logic
                    let duration = '-';
                    if(data.status === 'Running') duration = getDuration(data.startDate, null) + ' (Running)';
                    if(data.status === 'Closed') duration = getDuration(data.startDate, data.closeDate);

                    // 4. Action Buttons (Next State vs Undo)
                    let actionBtns = '';
                    
                    if(data.status === 'Pending' || !data.status) {
                        // Action: Start
                        actionBtns = `<button onclick="updateStatus('${id}', 'Running', 'next')" class="text-blue-600 hover:bg-blue-50 p-2 rounded" title="Start"><i class="fa-solid fa-play"></i></button>`;
                    } 
                    else if (data.status === 'Running') {
                        // Action: Close OR Undo to Pending
                        actionBtns = `
                            <button onclick="updateStatus('${id}', 'Pending', 'undo')" class="text-yellow-600 hover:bg-yellow-50 p-2 rounded" title="Undo to Pending"><i class="fa-solid fa-rotate-left"></i></button>
                            <button onclick="updateStatus('${id}', 'Closed', 'next')" class="text-green-600 hover:bg-green-50 p-2 rounded" title="Close Job"><i class="fa-solid fa-check"></i></button>
                        `;
                    } 
                    else if (data.status === 'Closed') {
                        // Action: Undo to Running
                        actionBtns = `<button onclick="updateStatus('${id}', 'Running', 'undo')" class="text-blue-600 hover:bg-blue-50 p-2 rounded" title="Undo to Running"><i class="fa-solid fa-rotate-left"></i></button>`;
                    }

                    const row = `
                        <tr class="border-b hover:bg-gray-50 transition text-sm">
                            <td class="p-3 font-medium text-blue-600">${data.piNo}</td>
                            <td class="p-3">${data.date}</td>
                            <td class="p-3 font-bold text-gray-700 truncate max-w-[150px]">${data.buyerName}</td>
                            <td class="p-3 text-right font-mono">${fmtQty}</td>
                            <td class="p-3 text-right font-mono font-bold">₹${fmtTotal}</td>
                            <td class="p-3 text-center"><span class="px-2 py-1 rounded-full text-[10px] font-bold ${badgeColor}">${data.status || 'Pending'}</span></td>
                            
                            <td class="p-3 text-xs text-gray-500">${data.startDate || '-'}</td>
                            <td class="p-3 text-xs text-gray-500">${data.closeDate || '-'}</td>
                            <td class="p-3 text-xs font-bold text-gray-600">${duration}</td>
                            
                            <td class="p-3 text-center flex items-center justify-center gap-1">
                                ${actionBtns}
                                <button onclick="editInvoice('${id}')" class="text-gray-500 hover:text-blue-600 p-2"><i class="fa-solid fa-pen-to-square"></i></button>
                            </td>
                        </tr>`;
                    tbody.innerHTML += row;
                });
            });
        }
        // --- BUYER MODAL ---
        function openBuyerModal() { document.getElementById('buyer-modal').classList.remove('hidden'); loadBuyers(); }
        function closeBuyerModal() { document.getElementById('buyer-modal').classList.add('hidden'); }
        async function saveNewBuyer() {
            const name = document.getElementById('new-buyer-name').value;
            const gst = document.getElementById('new-buyer-gst').value;
            const address = document.getElementById('new-buyer-address').value;
            if(!name) return alert("Buyer Name required");
            await window.addDoc(window.collection(window.db, "buyers"), { name, gst, address, timestamp: new Date() });
            selectBuyer({ name, gst, address });
        }
        function loadBuyers() {
            const list = document.getElementById('buyer-list');
            window.onSnapshot(window.query(window.collection(window.db, "buyers"), window.orderBy("timestamp", "desc")), (snap) => {
                list.innerHTML = '';
                snap.forEach(d => {
                    const b = d.data();
                    const safe = encodeURIComponent(JSON.stringify(b));
                    list.innerHTML += `<div onclick="selectBuyer(JSON.parse(decodeURIComponent('${safe}')))" class="p-3 border rounded hover:bg-blue-50 cursor-pointer flex justify-between"><div><div class="font-bold">${b.name}</div><div class="text-xs text-gray-500">${b.address}</div></div><i class="fa-solid fa-arrow-right self-center text-blue-400"></i></div>`;
                });
            });
        }
        function selectBuyer(data) {
            document.getElementById('inp-buyer-name').value = data.name;
            document.getElementById('inp-gst').value = data.gst;
            document.getElementById('inp-address').value = data.address;
            closeBuyerModal();
        }
        // --- HELPER FUNCTIONS ---
        function formatIndian(num) {
            const n = parseFloat(num) || 0;
            return n.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function getDuration(start, end) {
            if (!start) return '-';
            const s = new Date(start);
            const e = end ? new Date(end) : new Date(); // If no end date, use Today
            const diffTime = Math.abs(e - s);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            return diffDays + (diffDays === 1 ? ' Day' : ' Days');
        }
        // --- LOGIN UX ENHANCEMENTS ---
        document.addEventListener("DOMContentLoaded", () => {
            const pinInput = document.getElementById('pin-input');
            
            // 1. Auto Focus when page opens
            if(pinInput) {
                pinInput.focus();
                
                // 2. Login when "Enter" key is pressed
                pinInput.addEventListener("keypress", function(event) {
                    if (event.key === "Enter") {
                        checkLogin();
                    }
                });
            }
        });
    </script>
</body>
</html>
