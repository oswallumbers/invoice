<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Admin - Oswal Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; }
        .hidden { display: none !important; }
        .active-nav { background-color: #1e293b; border-left: 4px solid #3b82f6; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="admin-login-screen" class="min-h-screen flex flex-col justify-center items-center bg-slate-200">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border-t-4 border-slate-800">
            <div class="text-center mb-8">
                <i class="fas fa-user-tie text-6xl text-slate-700 mb-4"></i>
                <h1 class="text-3xl font-bold text-slate-800">HR Portal</h1>
                <p class="text-slate-500 font-semibold">Oswal Lumbers Pvt Ltd</p>
            </div>
            <input type="email" id="admin-email-input" placeholder="Admin Email" class="w-full p-4 mb-4 border rounded-xl bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-500 transition">
            <input type="password" id="admin-password-input" placeholder="Password" class="w-full p-4 mb-6 border rounded-xl bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-500 transition">
            <button onclick="adminLogin()" class="w-full bg-slate-800 text-white p-4 rounded-xl font-bold text-lg hover:bg-slate-900 transition shadow-lg transform active:scale-95">Secure Login</button>
        </div>
    </div>

    <div id="admin-dashboard" class="hidden flex h-screen overflow-hidden">
        
        <aside class="w-64 bg-slate-900 text-white flex flex-col fixed h-full z-20 shadow-2xl">
            <div class="p-6 border-b border-slate-800">
                <h1 class="text-xl font-bold text-white tracking-wide">Oswal <span class="text-blue-500">HR</span></h1>
                <p class="text-xs text-slate-400 mt-1">Admin Control Center</p>
            </div>
            <nav class="mt-4 flex-1 space-y-1">
                <a href="#" onclick="switchTab('dashboard')" id="nav-dashboard" class="active-nav block py-4 px-6 hover:bg-slate-800 transition flex items-center">
                    <i class="fas fa-chart-line w-8"></i> Live Logs
                </a>
                <a href="#" onclick="switchTab('staff')" id="nav-staff" class="block py-4 px-6 hover:bg-slate-800 transition flex items-center">
                    <i class="fas fa-users-cog w-8"></i> Staff & Salary
                </a>
                <a href="#" onclick="switchTab('payroll')" id="nav-payroll" class="block py-4 px-6 hover:bg-slate-800 transition flex items-center">
                    <i class="fas fa-file-invoice-dollar w-8"></i> Payroll (Salary)
                </a>
            </nav>
            <div class="p-4 bg-slate-900">
                <button onclick="logout()" class="w-full bg-red-600/20 text-red-400 py-3 rounded-lg text-sm font-bold hover:bg-red-600 hover:text-white transition border border-red-600/20"><i class="fas fa-sign-out-alt mr-2"></i> Logout</button>
            </div>
        </aside>

        <main class="flex-1 ml-64 p-8 overflow-y-auto h-full w-full bg-slate-100">
            
            <div id="section-dashboard" class="fade-in">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800">Daily Attendance</h2>
                        <p class="text-slate-500 text-sm">Real-time tracking & Late marks</p>
                    </div>
                    <div class="flex gap-2">
                        <input type="date" id="filter-date" class="p-3 border rounded-xl shadow-sm bg-white font-semibold text-slate-700 cursor-pointer" onchange="loadAttendance()">
                        <button onclick="exportTableToCSV('attendance-table', 'Attendance_Report')" class="bg-green-600 text-white px-4 py-3 rounded-xl font-bold hover:bg-green-700 shadow-lg transition flex items-center">
                            <i class="fas fa-file-excel mr-2"></i> Excel
                        </button>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse" id="attendance-table-el">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase tracking-wider font-bold">
                                <tr>
                                    <th class="p-5 border-b">Time</th>
                                    <th class="p-5 border-b">Employee</th>
                                    <th class="p-5 border-b">Status</th>
                                    <th class="p-5 border-b">Location</th>
                                    <th class="p-5 border-b">Device</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-table" class="text-sm font-medium"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="section-staff" class="hidden fade-in">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800">Staff Directory</h2>
                        <p class="text-slate-500">Add Names, Salary and Manage Locks.</p>
                    </div>
                    <button onclick="exportTableToCSV('staff-table-el', 'Staff_List')" class="bg-green-600 text-white px-4 py-3 rounded-xl font-bold hover:bg-green-700 shadow-lg transition flex items-center">
                        <i class="fas fa-file-excel mr-2"></i> Excel
                    </button>
                </div>

                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse" id="staff-table-el">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase tracking-wider font-bold">
                                <tr>
                                    <th class="p-5 border-b">Employee Name</th>
                                    <th class="p-5 border-b">Email</th>
                                    <th class="p-5 border-b">Daily Salary (₹)</th>
                                    <th class="p-5 border-b">Device Status</th>
                                    <th class="p-5 border-b text-right">Update</th>
                                </tr>
                            </thead>
                            <tbody id="staff-table" class="text-sm font-medium"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="section-payroll" class="hidden fade-in">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800">Monthly Payroll</h2>
                        <p class="text-slate-500">Auto-calculate salary based on attendance.</p>
                    </div>
                    <div class="flex gap-2">
                         <input type="month" id="payroll-month" class="p-3 border rounded-xl shadow-sm bg-white font-semibold text-slate-700 cursor-pointer">
                         <button onclick="calculatePayroll()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg transition">Calculate</button>
                         <button onclick="exportTableToCSV('payroll-table-el', 'Payroll_Report')" class="bg-green-600 text-white px-4 py-3 rounded-xl font-bold hover:bg-green-700 shadow-lg transition flex items-center">
                            <i class="fas fa-file-excel mr-2"></i> Excel
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse" id="payroll-table-el">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase tracking-wider font-bold">
                                <tr>
                                    <th class="p-5 border-b">Employee Name</th>
                                    <th class="p-5 border-b text-center">Days Present</th>
                                    <th class="p-5 border-b text-center text-red-500">Late Days</th>
                                    <th class="p-5 border-b text-right">Daily Rate</th>
                                    <th class="p-5 border-b text-right text-green-600 text-lg">Total Pay</th>
                                </tr>
                            </thead>
                            <tbody id="payroll-table" class="text-sm font-medium">
                                <tr><td colspan="5" class="p-10 text-center text-gray-400">Select a month and click Calculate.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, orderBy, Timestamp, doc, updateDoc, deleteField, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- SETTINGS ---
        const ADMIN_EMAIL = "admin@oswal.com";
        const OFFICE_START_HOUR = 9;   // 9 AM
        const OFFICE_START_MINUTE = 30; // 30 Minutes

        // --- AUTH & NAVIGATION ---
        const loginScreen = document.getElementById('admin-login-screen');
        const dashboard = document.getElementById('admin-dashboard');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                if(user.email !== ADMIN_EMAIL) { alert("Access Denied!"); signOut(auth); return; }
                loginScreen.classList.add('hidden');
                dashboard.classList.remove('hidden');
                loadAttendance();
            } else {
                loginScreen.classList.remove('hidden');
                dashboard.classList.add('hidden');
            }
        });

        window.adminLogin = () => {
            const e = document.getElementById('admin-email-input').value;
            const p = document.getElementById('admin-password-input').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => alert(err.message));
        };
        window.logout = () => signOut(auth);

        window.switchTab = (tab) => {
            ['dashboard', 'staff', 'payroll'].forEach(t => {
                document.getElementById('section-'+t).classList.add('hidden');
                document.getElementById('nav-'+t).classList.remove('active-nav');
            });
            document.getElementById('section-' + tab).classList.remove('hidden');
            document.getElementById('nav-' + tab).classList.add('active-nav');
            
            if(tab === 'staff') loadStaff();
        };

        // --- GLOBAL USER CACHE ---
        let userCache = {};
        async function fetchUserCache() {
            const snap = await getDocs(collection(db, "users"));
            snap.forEach(d => { userCache[d.id] = d.data(); });
        }

        // --- 1. DASHBOARD ---
        document.getElementById('filter-date').valueAsDate = new Date();
        
        window.loadAttendance = async () => {
            if(Object.keys(userCache).length === 0) await fetchUserCache();

            const tableBody = document.getElementById('attendance-table');
            tableBody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-500">Loading...</td></tr>';
            
            const selectedDate = new Date(document.getElementById('filter-date').value);
            const start = new Date(selectedDate.setHours(0,0,0,0));
            const end = new Date(selectedDate.setHours(23,59,59,999));

            try {
                const q = query(collection(db, "attendance"), where("timestamp", ">=", Timestamp.fromDate(start)), where("timestamp", "<=", Timestamp.fromDate(end)), orderBy("timestamp", "desc"));
                const snapshot = await getDocs(q);
                
                tableBody.innerHTML = '';
                if(snapshot.empty) { tableBody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400">No records found.</td></tr>'; return; }

                snapshot.forEach(doc => {
                    const d = doc.data();
                    const dateObj = d.timestamp.toDate();
                    const time = dateObj.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    
                    const userInfo = userCache[d.userId];
                    const displayName = (userInfo && userInfo.name) ? userInfo.name : d.userName;
                    const subText = (userInfo && userInfo.name) ? `<div class="text-xs text-gray-400">${d.userName}</div>` : '';

                    let typeHtml = d.type; // Plain text for export
                    let typeBadge = `<span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold uppercase">${d.type}</span>`;
                    let rowClass = "hover:bg-slate-50 border-b border-gray-100";

                    if (d.type === 'Check-In') {
                        const punchHour = dateObj.getHours();
                        const punchMin = dateObj.getMinutes();
                        if (punchHour > OFFICE_START_HOUR || (punchHour === OFFICE_START_HOUR && punchMin > OFFICE_START_MINUTE)) {
                            typeBadge = `<span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold uppercase flex items-center w-fit"><i class="fas fa-clock mr-1"></i> LATE</span>`;
                            typeHtml = "LATE Check-In";
                            rowClass = "bg-red-50 border-b border-red-100";
                        } else {
                            typeBadge = `<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold uppercase">ON TIME</span>`;
                            typeHtml = "On Time Check-In";
                        }
                    }

                    const locHtml = d.location ? `<a href="http://googleusercontent.com/maps.google.com/5{d.location.lat},${d.location.lng}" target="_blank" class="text-blue-500 hover:text-blue-700"><i class="fas fa-map-marker-alt"></i> View</a>` : '-';
                    const locText = d.location ? `${d.location.lat}, ${d.location.lng}` : 'N/A'; // For Export

                    tableBody.innerHTML += `
                        <tr class="${rowClass} transition">
                            <td class="p-5 text-slate-700 font-mono">${time}</td>
                            <td class="p-5 font-semibold text-slate-800">
                                ${displayName} ${subText}
                            </td>
                            <td class="p-5" data-val="${typeHtml}">${typeBadge}</td>
                            <td class="p-5" data-val="${locText}">${locHtml}</td>
                            <td class="p-5 text-xs text-slate-400 truncate max-w-[100px]">${d.device || 'N/A'}</td>
                        </tr>`;
                });
            } catch (e) { console.error(e); }
        };

        // --- 2. STAFF & SALARY MANAGEMENT ---
        window.loadStaff = async () => {
            const tableBody = document.getElementById('staff-table');
            tableBody.innerHTML = '<tr><td colspan="5" class="p-6 text-center">Loading...</td></tr>';
            
            try {
                const q = query(collection(db, "users"));
                const snapshot = await getDocs(q);
                
                tableBody.innerHTML = '';
                if(snapshot.empty) { tableBody.innerHTML = '<tr><td colspan="5" class="p-6 text-center">No staff found.</td></tr>'; return; }

                snapshot.forEach(docSnap => {
                    const user = docSnap.data();
                    const userId = docSnap.id;
                    const salary = user.dailySalary || 0;
                    const name = user.name || ''; 
                    
                    let deviceStatus = user.registeredDevice 
                        ? `<span class="text-slate-500 text-xs flex items-center"><i class="fas fa-lock text-orange-500 mr-2"></i> Locked</span>`
                        : `<span class="text-green-500 text-xs">Open</span>`;
                    
                    let deviceText = user.registeredDevice ? "Locked" : "Open"; // For Export

                    let resetButton = user.registeredDevice 
                        ? `<button onclick="resetDevice('${userId}')" class="text-xs bg-orange-50 text-orange-600 px-2 py-1 rounded border border-orange-200 hover:bg-orange-100 font-bold ml-2">Reset Device</button>` 
                        : '';

                    tableBody.innerHTML += `
                        <tr class="border-b border-gray-100 hover:bg-slate-50">
                            <td class="p-5">
                                <input type="text" id="name-${userId}" value="${name}" placeholder="Enter Name" class="w-full p-2 border border-gray-300 rounded mb-1 font-bold text-slate-700 focus:border-blue-500 focus:outline-none">
                            </td>
                            <td class="p-5 text-gray-600 font-mono text-xs">${user.email}</td>
                            <td class="p-5">
                                <div class="flex items-center">
                                    <span class="text-gray-500 mr-2">₹</span>
                                    <input type="number" id="salary-${userId}" value="${salary}" class="w-24 p-2 border rounded bg-white text-right font-mono" placeholder="0">
                                </div>
                            </td>
                            <td class="p-5" data-val="${deviceText}">${deviceStatus}</td>
                            <td class="p-5 text-right flex justify-end items-center mt-2">
                                <button onclick="saveUser('${userId}')" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 transition text-xs font-bold"><i class="fas fa-save mr-1"></i> Save</button>
                                ${resetButton}
                            </td>
                        </tr>`;
                });
            } catch(e) { console.error(e); }
        };

        window.saveUser = async (userId) => {
            const amount = document.getElementById(`salary-${userId}`).value;
            const name = document.getElementById(`name-${userId}`).value;
            const btn = event.currentTarget;
            const oldText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                await setDoc(doc(db, "users", userId), { dailySalary: Number(amount), name: name }, { merge: true });
                await fetchUserCache();
                alert("Updated!");
            } catch(e) { alert("Error: " + e.message); }
            btn.innerHTML = oldText;
        };

        window.resetDevice = async (userId) => {
            if(confirm("Unlock device?")) {
                await updateDoc(doc(db, "users", userId), { registeredDevice: deleteField() });
                loadStaff();
            }
        };

        // --- 3. PAYROLL CALCULATION ---
        window.calculatePayroll = async () => {
            const monthInput = document.getElementById('payroll-month').value;
            if(!monthInput) { alert("Select a month first."); return; }

            const [year, month] = monthInput.split('-');
            const startOfMonth = new Date(year, month - 1, 1);
            const endOfMonth = new Date(year, month, 0, 23, 59, 59);
            
            const tableBody = document.getElementById('payroll-table');
            tableBody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-blue-500"><i class="fas fa-spinner fa-spin text-2xl"></i> Calculating...</td></tr>';

            try {
                const usersSnap = await getDocs(collection(db, "users"));
                const userMap = {};
                usersSnap.forEach(u => {
                    const d = u.data();
                    userMap[u.id] = { 
                        name: d.name || d.email, 
                        email: d.email,
                        salary: d.dailySalary || 0,
                        daysPresent: new Set(),
                        lateCount: 0
                    };
                });

                const q = query(collection(db, "attendance"), 
                    where("timestamp", ">=", Timestamp.fromDate(startOfMonth)),
                    where("timestamp", "<=", Timestamp.fromDate(endOfMonth))
                );
                const attSnap = await getDocs(q);

                attSnap.forEach(doc => {
                    const d = doc.data();
                    if(userMap[d.userId]) {
                        const dateStr = d.timestamp.toDate().toDateString();
                        userMap[d.userId].daysPresent.add(dateStr);
                        if(d.type === 'Check-In') {
                            const dateObj = d.timestamp.toDate();
                            if (dateObj.getHours() > OFFICE_START_HOUR || (dateObj.getHours() === OFFICE_START_HOUR && dateObj.getMinutes() > OFFICE_START_MINUTE)) {
                                userMap[d.userId].lateCount++;
                            }
                        }
                    }
                });

                tableBody.innerHTML = '';
                Object.values(userMap).forEach(u => {
                    const days = u.daysPresent.size;
                    const totalPay = days * u.salary;

                    if(days > 0) {
                        tableBody.innerHTML += `
                            <tr class="border-b border-gray-100 hover:bg-slate-50">
                                <td class="p-5 font-bold text-slate-800">${u.name}</td>
                                <td class="p-5 text-center font-bold text-blue-600">${days}</td>
                                <td class="p-5 text-center text-red-500 font-bold">${u.lateCount > 0 ? u.lateCount : '0'}</td>
                                <td class="p-5 text-right font-mono text-gray-500">₹${u.salary}</td>
                                <td class="p-5 text-right font-bold text-green-600 text-xl font-mono">₹${totalPay.toLocaleString()}</td>
                            </tr>`;
                    }
                });
                
                if(tableBody.innerHTML === '') {
                     tableBody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-gray-400">No attendance data found for this month.</td></tr>';
                }

            } catch(e) { console.error(e); alert("Error: " + e.message); }
        };

        // --- GLOBAL EXPORT TO CSV FUNCTION ---
        window.exportTableToCSV = (tableId, filename) => {
            const table = document.getElementById(tableId);
            const rows = Array.from(table.rows);
            let csvContent = "";

            rows.forEach(row => {
                let rowData = [];
                Array.from(row.cells).forEach(cell => {
                    // 1. Check if cell has data-val attribute (Used for clean Status/Location)
                    if(cell.hasAttribute('data-val')) {
                        rowData.push(cell.getAttribute('data-val'));
                    } 
                    // 2. Check if cell has an input field (Staff Name/Salary)
                    else if (cell.querySelector('input')) {
                        rowData.push(cell.querySelector('input').value);
                    } 
                    // 3. Otherwise just get text
                    else {
                        // Clean up newlines and commas
                        let text = cell.innerText.replace(/(\r\n|\n|\r)/gm, " ").replace(/,/g, " ");
                        // Remove "View" text from maps link
                        text = text.replace("View", "").replace("Update", "").replace("Save", "").replace("Reset Device", "").trim();
                        rowData.push(text);
                    }
                });
                // Remove last empty Action columns if needed or keep for structure
                csvContent += rowData.join(",") + "\n";
            });

            // Trigger Download
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename + "_" + new Date().toISOString().slice(0,10) + ".csv";
            link.click();
        };

    </script>
</body>
</html>