<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oswal Attendance</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2921/2921226.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; }
        .fingerprint-anim { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="h-screen flex flex-col select-none">

    <div id="login-screen" class="flex-1 flex flex-col justify-center items-center p-6 bg-white">
        <div class="w-full max-w-sm text-center">
            <div class="mb-8 relative">
                <i class="fas fa-mobile-alt text-6xl text-blue-600"></i>
                <i class="fas fa-lock absolute -bottom-2 -right-2 text-2xl text-orange-500 bg-white rounded-full p-1"></i>
            </div>
            <h1 class="text-2xl font-bold mb-2">Secure Login</h1>
            <p class="text-gray-500 mb-6 text-sm">This device will be linked to your ID.</p>
            
            <input type="email" id="email" placeholder="Email" class="w-full p-4 mb-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="password" id="password" placeholder="Password" class="w-full p-4 mb-6 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <button onclick="login()" id="login-btn" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold text-lg shadow-lg hover:bg-blue-700 transition">
                Link Device & Login
            </button>
            <p id="login-msg" class="text-red-500 text-sm mt-4 font-bold"></p>
        </div>
    </div>

    <div id="loading-screen" class="hidden fixed inset-0 bg-white z-50 flex flex-col justify-center items-center">
        <i class="fas fa-circle-notch fa-spin text-4xl text-blue-600 mb-4"></i>
        <p class="text-gray-600 font-bold">Verifying Device ID...</p>
    </div>

    <div id="dashboard-screen" class="hidden flex-1 flex flex-col relative">
        <div class="bg-blue-600 text-white p-6 rounded-b-3xl shadow-lg z-10">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-bold" id="user-name">User</h2>
                    <p class="text-blue-100 text-xs mt-1"><i class="fas fa-mobile-alt"></i> Device Linked</p>
                </div>
                <button onclick="logout()" class="bg-blue-700 p-2 rounded-lg text-xs"><i class="fas fa-power-off"></i></button>
            </div>
            <div class="mt-4 flex items-center bg-blue-800/50 p-2 rounded-lg backdrop-blur-sm">
                <div id="loc-icon" class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center mr-3">
                    <i class="fas fa-satellite-dish text-gray-500 animate-pulse"></i>
                </div>
                <div>
                    <p class="text-xs text-blue-200 uppercase tracking-wider">Location Status</p>
                    <p class="font-bold text-sm" id="location-status">Locating...</p>
                </div>
            </div>
        </div>

        <div class="flex-1 flex flex-col justify-center items-center p-6 space-y-6">
            <button onclick="triggerBiometric('Check-In')" id="btn-in" class="w-full max-w-xs bg-white border-2 border-green-100 p-6 rounded-2xl shadow-sm hover:shadow-md active:scale-95 transition flex items-center justify-between group">
                <div class="flex items-center">
                    <div class="w-12 h-12 rounded-full bg-green-50 flex items-center justify-center mr-4 group-hover:bg-green-100 transition">
                        <i class="fas fa-fingerprint text-green-600 text-xl"></i>
                    </div>
                    <div class="text-left">
                        <h3 class="font-bold text-gray-800 text-lg">Check In</h3>
                        <p class="text-xs text-gray-400">Scan Fingerprint</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-300"></i>
            </button>

            <button onclick="triggerBiometric('Check-Out')" id="btn-out" class="w-full max-w-xs bg-white border-2 border-red-100 p-6 rounded-2xl shadow-sm hover:shadow-md active:scale-95 transition flex items-center justify-between group">
                <div class="flex items-center">
                    <div class="w-12 h-12 rounded-full bg-red-50 flex items-center justify-center mr-4 group-hover:bg-red-100 transition">
                        <i class="fas fa-fingerprint text-red-600 text-xl"></i>
                    </div>
                    <div class="text-left">
                        <h3 class="font-bold text-gray-800 text-lg">Check Out</h3>
                        <p class="text-xs text-gray-400">Scan Fingerprint</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-gray-300"></i>
            </button>
        </div>

        <div class="bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.05)] p-6 h-1/3 overflow-y-auto">
            <h3 class="font-bold text-gray-800 mb-4">Today's Activity</h3>
            <ul id="activity-log" class="space-y-4"></ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, getDoc, setDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- PWA SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }

        const firebaseConfig = {
            apiKey: "AIzaSyB-R05CTNKajcFMpbkutCesDCGLOZknehA",
            authDomain: "attendance-97b55.firebaseapp.com",
            projectId: "attendance-97b55",
            storageBucket: "attendance-97b55.firebasestorage.app",
            messagingSenderId: "412503486002",
            appId: "1:412503486002:web:8b78c0b5b58ae49895562b",
            measurementId: "G-3GJK5P4780"
        };


        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Office Settings
        const OFFICE_LAT = 23.091557; 
        const OFFICE_LNG = 70.144753; 
        const ALLOWED_RADIUS = 200; 

        let currentUser = null;
        let userLocation = null;
        let isLocationValid = false;

        // --- 1. DEVICE ID LOGIC ---
        function getLocalDeviceId() {
            let deviceId = localStorage.getItem('oswal_device_id');
            if (!deviceId) {
                deviceId = 'dev_' + Math.random().toString(36).substr(2, 9) + Date.now();
                localStorage.setItem('oswal_device_id', deviceId);
            }
            return deviceId;
        }

        // --- 2. AUTH & DEVICE CHECK ---
        window.login = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            document.getElementById('login-btn').innerText = "Verifying...";
            signInWithEmailAndPassword(auth, e, p).catch(err => {
                document.getElementById('login-msg').innerText = err.message;
                document.getElementById('login-btn').innerText = "Link Device & Login";
            });
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            const loginScreen = document.getElementById('login-screen');
            const dashboard = document.getElementById('dashboard-screen');
            const loadingScreen = document.getElementById('loading-screen');

            if (user) {
                loginScreen.classList.add('hidden');
                loadingScreen.classList.remove('hidden'); // Show loader while checking device

                // --- CRITICAL: DEVICE LOCK CHECK ---
                const localDeviceId = getLocalDeviceId();
                const userDocRef = doc(db, "users", user.uid);

                try {
                    const userSnap = await getDoc(userDocRef);

                    if (!userSnap.exists()) {
                        // CASE A: First time user ever. Lock this device to them.
                        await setDoc(userDocRef, { 
                            email: user.email, 
                            registeredDevice: localDeviceId,
                            joinedAt: Timestamp.now()
                        }, { merge: true }); // Merge to not overwrite other info
                        console.log("Device Registered Successfully");
                        enterDashboard(user);
                    } else {
                        // CASE B: User exists. Check if device matches.
                        const data = userSnap.data();
                        
                        // If no device registered yet (migration), register this one
                        if (!data.registeredDevice) {
                            await setDoc(userDocRef, { registeredDevice: localDeviceId }, { merge: true });
                            enterDashboard(user);
                        } 
                        // If device matches
                        else if (data.registeredDevice === localDeviceId) {
                            enterDashboard(user);
                        } 
                        // CASE C: DEVICE MISMATCH (Fraud Attempt)
                        else {
                            alert(`SECURITY ALERT:\nThis account is locked to another device.\n\nYou cannot use this phone.`);
                            await signOut(auth);
                            loadingScreen.classList.add('hidden');
                            loginScreen.classList.remove('hidden');
                            document.getElementById('login-msg').innerText = "Account Locked to another device.";
                            document.getElementById('login-btn').innerText = "Link Device & Login";
                        }
                    }
                } catch (error) {
                    console.error("Device Check Error:", error);
                    alert("System Error. Try again.");
                    signOut(auth);
                }

            } else {
                currentUser = null;
                loadingScreen.classList.add('hidden');
                dashboard.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                document.getElementById('login-btn').innerText = "Link Device & Login";
            }
        });

        function enterDashboard(user) {
            currentUser = user;
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('dashboard-screen').classList.remove('hidden');
            document.getElementById('user-name').innerText = user.email.split('@')[0];
            startLocation();
            loadLogs();
        }

        // --- 3. GEOLOCATION ---
        function startLocation() {
            if (!navigator.geolocation) return;
            navigator.geolocation.watchPosition(pos => {
                userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                
                // Testing Logs (Remove later)
                console.log("Lat:", userLocation.lat, "Lng:", userLocation.lng);

                const dist = getDist(userLocation.lat, userLocation.lng, OFFICE_LAT, OFFICE_LNG);
                const statusEl = document.getElementById('location-status');
                const iconEl = document.getElementById('loc-icon');

                if (dist <= ALLOWED_RADIUS) {
                    isLocationValid = true;
                    statusEl.innerText = "Verified: Inside Office";
                    statusEl.className = "font-bold text-sm text-green-300";
                    iconEl.innerHTML = '<i class="fas fa-check text-green-600"></i>';
                    iconEl.className = "w-8 h-8 rounded-full bg-green-100 flex items-center justify-center mr-3";
                } else {
                    isLocationValid = false;
                    statusEl.innerText = `Outside Office (${Math.round(dist)}m)`;
                    statusEl.className = "font-bold text-sm text-red-300";
                    iconEl.innerHTML = '<i class="fas fa-times text-red-600"></i>';
                    iconEl.className = "w-8 h-8 rounded-full bg-red-100 flex items-center justify-center mr-3";
                }
            }, err => console.error(err), { enableHighAccuracy: true });
        }

        // --- 4. BIOMETRIC (WEBAUTHN) ---
        window.triggerBiometric = async (type) => {
            if (!currentUser) return;
            if (!userLocation) { alert("Waiting for location..."); return; }
            // if (!isLocationValid) { alert("You are not at the office location."); return; } // Uncomment for strict mode

            try {
                // Dummy WebAuthn for Fingerprint Prompt
                const publicKey = {
                    challenge: new Uint8Array([1, 2, 3, 4, 5, 6, 7, 8]),
                    rp: { name: "Oswal Attendance" },
                    user: {
                        id: Uint8Array.from(currentUser.uid, c => c.charCodeAt(0)),
                        name: currentUser.email,
                        displayName: currentUser.email
                    },
                    pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                    authenticatorSelection: { authenticatorAttachment: "platform", userVerification: "required" },
                    timeout: 60000
                };
                
                await navigator.credentials.create({ publicKey });
                await saveAttendance(type);

            } catch (err) {
                console.error(err);
                alert("Biometric verification failed or canceled.");
            }
        };

        async function saveAttendance(type) {
            try {
                await addDoc(collection(db, "attendance"), {
                    userId: currentUser.uid,
                    userName: currentUser.email,
                    type: type,
                    timestamp: Timestamp.now(),
                    location: userLocation,
                    method: "Biometric + Device Lock",
                    device: navigator.userAgent
                });
                alert(type + " Marked Successfully!");
                loadLogs();
            } catch (e) {
                alert("Error saving data: " + e.message);
            }
        }

        // --- UTILS ---
        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const φ1 = lat1 * Math.PI/180, φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180, Δλ = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        async function loadLogs() {
            const list = document.getElementById('activity-log');
            list.innerHTML = '';
            const today = new Date(); today.setHours(0,0,0,0);
            
            const q = query(collection(db, "attendance"), where("userId", "==", currentUser.uid), where("timestamp", ">=", Timestamp.fromDate(today)));
            const snaps = await getDocs(q);
            
            if(snaps.empty) list.innerHTML = '<p class="text-gray-400 text-center text-sm">No punch-ins today.</p>';

            snaps.forEach(doc => {
                const d = doc.data();
                const time = d.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                const isCheckIn = d.type === 'Check-In';
                list.innerHTML += `
                    <li class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full ${isCheckIn?'bg-green-100':'bg-red-100'} flex items-center justify-center mr-3">
                                <i class="fas ${isCheckIn?'fa-arrow-right':'fa-arrow-left'} ${isCheckIn?'text-green-600':'text-red-600'}"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-800">${d.type}</p>
                                <p class="text-xs text-gray-500">Verified</p>
                            </div>
                        </div>
                        <span class="font-bold text-gray-600">${time}</span>
                    </li>`;
            });
        }
    </script>
</body>
</html>
