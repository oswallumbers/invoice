<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oswal Attendance</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2921/2921226.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; }
        
        /* Modal Background */
        .modal-bg { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }

        /* Full Screen Success Animation */
        #success-flash { transition: opacity 0.3s ease-in-out; }
        .scale-up { animation: scaleUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes scaleUp {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Notification Badge Animation */
        .bell-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body class="h-screen flex flex-col select-none">

    <video id="hidden-video" autoplay playsinline class="hidden w-1 h-1 absolute top-0 left-0"></video>
    <canvas id="hidden-canvas" class="hidden"></canvas>

    <div id="success-flash" class="hidden fixed inset-0 z-[100] bg-green-500 flex flex-col justify-center items-center text-white">
        <div class="bg-white rounded-full p-8 mb-4 shadow-2xl scale-up">
            <i class="fas fa-check text-8xl text-green-500"></i>
        </div>
        <h2 class="text-3xl font-bold tracking-wide animate-pulse">SUCCESS!</h2>
        <p class="text-green-100 mt-2 text-lg" id="success-msg">Attendance Marked</p>
    </div>

    <div id="login-screen" class="flex-1 flex flex-col justify-center items-center p-6 bg-white">
        <div class="w-full max-w-sm text-center">
            <div class="mb-8 relative inline-block">
                <i class="fas fa-mobile-alt text-6xl text-blue-600"></i>
                <i class="fas fa-lock absolute -bottom-2 -right-2 text-2xl text-orange-500 bg-white rounded-full p-1 shadow"></i>
            </div>
            <h1 class="text-2xl font-bold mb-2">Secure Login</h1>
            <p class="text-gray-500 mb-6 text-sm">Device will be locked to your ID.</p>
            
            <input type="email" id="email" placeholder="Email" class="w-full p-4 mb-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="password" id="password" placeholder="Password" class="w-full p-4 mb-6 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <button onclick="login()" id="login-btn" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold text-lg shadow-lg hover:bg-blue-700 transition">
                Link Device & Login
            </button>
            <button id="install-btn" class="hidden w-full bg-gray-900 text-white p-4 rounded-xl font-bold text-lg shadow-lg mt-3 transition hover:bg-black flex items-center justify-center">
                <i class="fas fa-download mr-2"></i> Install App
            </button>
            <button onclick="testNotification()" class="w-full bg-purple-100 text-purple-700 p-3 rounded-xl font-bold mt-2 text-sm border border-purple-200">
            <i class="fas fa-bell"></i> Test Notification Now
        </button>
            <p id="login-msg" class="text-red-500 text-sm mt-4 font-bold"></p>
        </div>
    </div>

    <div id="loading-screen" class="hidden fixed inset-0 bg-white z-50 flex flex-col justify-center items-center">
        <i class="fas fa-circle-notch fa-spin text-4xl text-blue-600 mb-4"></i>
        <p class="text-gray-600 font-bold">Verifying Device...</p>
    </div>

    <div id="dashboard-screen" class="hidden flex-1 flex flex-col relative">
        <div class="bg-blue-600 text-white p-6 rounded-b-3xl shadow-lg z-10 transition-colors duration-500" id="header-bg">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-bold" id="user-name">User</h2>
                    <p class="text-blue-100 text-xs mt-1" id="connection-status"><i class="fas fa-wifi"></i> Online</p>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="toggleNotifPanel()" class="relative bg-blue-700 p-2 rounded-lg text-white hover:bg-blue-800 transition">
                        <i class="fas fa-bell" id="bell-icon"></i>
                        <span id="notif-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center font-bold">0</span>
                    </button>
                    <button onclick="logout()" class="bg-blue-700 p-2 rounded-lg text-xs"><i class="fas fa-power-off"></i></button>
                </div>
            </div>
            <div class="mt-4 flex items-center bg-blue-800/50 p-2 rounded-lg backdrop-blur-sm">
                <div id="loc-icon" class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center mr-3">
                    <i class="fas fa-satellite-dish text-gray-500 animate-pulse"></i>
                </div>
                <div>
                    <p class="text-xs text-blue-200 uppercase tracking-wider">Location</p>
                    <p class="font-bold text-sm" id="location-status">Locating...</p>
                </div>
            </div>
        </div>

        <div class="flex-1 flex flex-col justify-center items-center p-6 space-y-4">
            
            <div id="sync-alert" class="hidden w-full bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 rounded shadow-sm flex justify-between items-center">
                <div><p class="font-bold">Offline Data Pending</p></div>
                <i class="fas fa-sync fa-spin text-orange-500"></i>
            </div>

            <button id="btn-allow-notif" onclick="requestNotificationPermission()" class="hidden w-full bg-yellow-100 text-yellow-800 p-3 rounded-xl text-sm font-bold border border-yellow-300">
                <i class="fas fa-bell mr-2"></i> Enable Attendance Reminders
            </button>

            <div id="smart-buttons-area" class="w-full flex justify-center">
                <div id="btn-loading" class="text-gray-400 font-bold animate-pulse">Checking Status...</div>

                <button onclick="triggerBiometric('Check-In')" id="btn-in" class="hidden w-full max-w-xs bg-white border-2 border-green-100 p-6 rounded-2xl shadow-sm hover:shadow-md active:scale-95 transition flex items-center justify-between group">
                    <div class="flex items-center">
                        <div class="w-12 h-12 rounded-full bg-green-50 flex items-center justify-center mr-4 group-hover:bg-green-100 transition">
                            <i class="fas fa-fingerprint text-green-600 text-xl"></i>
                        </div>
                        <div class="text-left">
                            <h3 class="font-bold text-gray-800 text-lg">Check In</h3>
                            <p class="text-xs text-gray-400">Start Day</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </button>

                <button onclick="triggerBiometric('Check-Out')" id="btn-out" class="hidden w-full max-w-xs bg-white border-2 border-red-100 p-6 rounded-2xl shadow-sm hover:shadow-md active:scale-95 transition flex items-center justify-between group">
                    <div class="flex items-center">
                        <div class="w-12 h-12 rounded-full bg-red-50 flex items-center justify-center mr-4 group-hover:bg-red-100 transition">
                            <i class="fas fa-fingerprint text-red-600 text-xl"></i>
                        </div>
                        <div class="text-left">
                            <h3 class="font-bold text-gray-800 text-lg">Check Out</h3>
                            <p class="text-xs text-gray-400">End Day</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </button>
            </div>

            <div class="mt-4">
                <button onclick="openRequestModal()" class="text-blue-500 text-sm font-semibold hover:underline">
                    <i class="fas fa-question-circle"></i> Forgot to Punch?
                </button>
            </div>
        </div>

        <div class="bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.05)] p-6 h-1/3 overflow-y-auto">
            <h3 class="font-bold text-gray-800 mb-4">Today's Activity</h3>
            <ul id="activity-log" class="space-y-4"></ul>
        </div>
    </div>

    <div id="notif-panel" class="hidden fixed inset-0 z-40">
        <div class="absolute inset-0 bg-black/50" onclick="toggleNotifPanel()"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-3xl p-6 h-3/4 overflow-y-auto transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Notifications</h3>
                <button onclick="clearNotifications()" class="text-xs text-red-500 font-bold">Clear All</button>
            </div>
            <ul id="notif-list" class="space-y-3">
                <li class="text-center text-gray-400 text-sm mt-10">No new notifications</li>
            </ul>
        </div>
    </div>

    <div id="request-modal" class="hidden fixed inset-0 modal-bg z-50 flex justify-center items-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-1">Forgot Punch?</h3>
            <p class="text-xs text-gray-500 mb-4">Send a request to Admin to fix attendance.</p>
            <div class="space-y-3">
                <input type="date" id="req-date" class="w-full p-3 bg-gray-50 border rounded-lg text-sm">
                <input type="time" id="req-time" class="w-full p-3 bg-gray-50 border rounded-lg text-sm">
                <select id="req-type" class="w-full p-3 bg-gray-50 border rounded-lg text-sm">
                    <option value="Check-In">I forgot to Check-In</option>
                    <option value="Check-Out">I forgot to Check-Out</option>
                </select>
                <textarea id="req-reason" placeholder="Reason (e.g. Battery dead)" class="w-full p-3 bg-gray-50 border rounded-lg text-sm h-20"></textarea>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeRequestModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold text-sm">Cancel</button>
                <button onclick="sendRequest()" id="btn-send-req" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg">Send Request</button>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then((registration) => {
                registration.onupdatefound = () => {
                    const newWorker = registration.installing;
                    newWorker.onstatechange = () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            if(confirm("New Update Available! Click OK to Refresh.")) { window.location.reload(); }
                        }
                    };
                };
            });
            let refreshing;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                window.location.reload();
                refreshing = true;
            });
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, getDoc, setDoc, Timestamp, limit, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyB-R05CTNKajcFMpbkutCesDCGLOZknehA",
            authDomain: "attendance-97b55.firebaseapp.com",
            projectId: "attendance-97b55",
            storageBucket: "attendance-97b55.firebasestorage.app",
            messagingSenderId: "412503486002",
            appId: "1:412503486002:web:8b78c0b5b58ae49895562b",
            measurementId: "G-3GJK5P4780"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const OFFICE_LAT = 23.091557; 
        const OFFICE_LNG = 70.144753; 
        const ALLOWED_RADIUS = 500; 

        let currentUser = null;
        let currentUserName = ""; 
        let userLocation = null;
        let isOnline = navigator.onLine;

        // --- PWA INSTALL LOGIC (NEW) ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('install-btn');
            if(btn) {
                btn.classList.remove('hidden');
                btn.addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            btn.classList.add('hidden');
                        }
                        deferredPrompt = null;
                    }
                });
            }
        });
        window.addEventListener('appinstalled', () => {
            const btn = document.getElementById('install-btn');
            if(btn) btn.classList.add('hidden');
        });

        function getLocalDeviceId() {
            let deviceId = localStorage.getItem('oswal_device_id');
            if (!deviceId) {
                deviceId = 'dev_' + Math.random().toString(36).substr(2, 9) + Date.now();
                localStorage.setItem('oswal_device_id', deviceId);
            }
            return deviceId;
        }

        window.login = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            if(!e || !p) return;
            document.getElementById('login-btn').innerText = "Verifying...";
            signInWithEmailAndPassword(auth, e, p).catch(err => {
                document.getElementById('login-msg').innerText = "Invalid Credentials";
                document.getElementById('login-btn').innerText = "Link Device & Login";
            });
        };
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('loading-screen').classList.remove('hidden');

                if (navigator.onLine) {
                    const localDeviceId = getLocalDeviceId();
                    const userDocRef = doc(db, "users", user.uid);
                    try {
                        const userSnap = await getDoc(userDocRef);
                        if (!userSnap.exists()) {
                             await setDoc(userDocRef, { email: user.email, registeredDevice: localDeviceId, joinedAt: Timestamp.now() }, { merge: true });
                             enterDashboard(user);
                        } else {
                            const data = userSnap.data();
                            if (!data.registeredDevice || data.registeredDevice === localDeviceId) {
                                if(!data.registeredDevice) await setDoc(userDocRef, { registeredDevice: localDeviceId }, { merge: true });
                                enterDashboard(user);
                            } else {
                                alert(`LOCKED: This ID is registered to another device.`);
                                await signOut(auth);
                                location.reload();
                            }
                        }
                    } catch (e) { enterDashboard(user); }
                } else { enterDashboard(user); }
            } else {
                currentUser = null;
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('dashboard-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('login-btn').innerText = "Link Device & Login";
            }
        });

        // --- SELFIE CAPTURE FUNCTION (NO STORAGE) ---
        async function captureSelfie() {
            const video = document.getElementById('hidden-video');
            const canvas = document.getElementById('hidden-canvas');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                video.srcObject = stream;
                await new Promise(resolve => video.onloadedmetadata = resolve);
                const ctx = canvas.getContext('2d');
                canvas.width = 300;
                canvas.height = 300;
                ctx.drawImage(video, 0, 0, 300, 300);
                const base64Image = canvas.toDataURL('image/jpeg', 0.5);
                stream.getTracks().forEach(track => track.stop());
                return base64Image;
            } catch (e) {
                console.error("Camera Error:", e);
                return "No Photo (Camera Error)";
            }
        }

        async function enterDashboard(user) {
            currentUser = user;
            try {
                const docSnap = await getDoc(doc(db, "users", user.uid));
                if(docSnap.exists() && docSnap.data().name) {
                    currentUserName = docSnap.data().name; 
                } else {
                    currentUserName = user.email.split('@')[0]; 
                }
            } catch(e) { 
                currentUserName = user.email.split('@')[0]; 
            }
            document.getElementById('user-name').innerText = currentUserName;
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('dashboard-screen').classList.remove('hidden');
            
            startLocation();
            loadLogs();
            checkOfflineQueue();
            updateUIBasedOnLastPunch(); 

            // --- START NOTIFICATION SYSTEM ---
            checkNotificationPermission();
            startNotificationScheduler();
            updateNotificationUI();
        }

        async function updateUIBasedOnLastPunch() {
            if (!isOnline) {
                document.getElementById('btn-loading').classList.add('hidden');
                document.getElementById('btn-in').classList.remove('hidden'); 
                return; 
            }
            const today = new Date(); today.setHours(0,0,0,0);
            const q = query(
                collection(db, "attendance"),
                where("userId", "==", currentUser.uid),
                where("timestamp", ">=", Timestamp.fromDate(today)),
                orderBy("timestamp", "desc"),
                limit(1)
            );

            try {
                const snapshot = await getDocs(q);
                document.getElementById('btn-loading').classList.add('hidden');
                
                if (snapshot.empty) {
                    document.getElementById('btn-in').classList.remove('hidden');
                    document.getElementById('btn-out').classList.add('hidden');
                } else {
                    const lastData = snapshot.docs[0].data();
                    if (lastData.type === 'Check-In') {
                        document.getElementById('btn-in').classList.add('hidden');
                        document.getElementById('btn-out').classList.remove('hidden');
                    } else {
                        document.getElementById('btn-in').classList.remove('hidden');
                        document.getElementById('btn-out').classList.add('hidden');
                    }
                }
            } catch (e) {
                console.error("Error fetching status", e);
                document.getElementById('btn-loading').innerText = "Error loading status";
            }
        }

        window.openRequestModal = () => {
            document.getElementById('request-modal').classList.remove('hidden');
            document.getElementById('req-date').valueAsDate = new Date();
        };
        window.closeRequestModal = () => document.getElementById('request-modal').classList.add('hidden');

        window.sendRequest = async () => {
            const date = document.getElementById('req-date').value;
            const time = document.getElementById('req-time').value;
            const type = document.getElementById('req-type').value;
            const reason = document.getElementById('req-reason').value;
            if(!date || !time || !reason) { alert("Please fill all details"); return; }
            const btn = document.getElementById('btn-send-req');
            btn.innerText = "Sending...";
            try {
                await addDoc(collection(db, "requests"), {
                    userId: currentUser.uid, userName: currentUser.email, date: date, time: time, type: type, reason: reason, status: 'Pending', timestamp: Timestamp.now()
                });
                alert("Request Sent Successfully!");
                closeRequestModal();
                document.getElementById('req-reason').value = "";
            } catch(e) { alert("Error sending request: " + e.message); }
            btn.innerText = "Send Request";
        };

        window.addEventListener('online', () => { isOnline = true; syncOfflineData(); updateUIBasedOnLastPunch(); });
        window.addEventListener('offline', () => { isOnline = false; });

        function startLocation() {
            if (!navigator.geolocation) return;
            const options = { enableHighAccuracy: true, maximumAge: 60000, timeout: 15000 };
            navigator.geolocation.watchPosition(pos => {
                userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                const dist = getDist(userLocation.lat, userLocation.lng, OFFICE_LAT, OFFICE_LNG);
                const statusEl = document.getElementById('location-status');
                const iconEl = document.getElementById('loc-icon');
                if (dist <= ALLOWED_RADIUS) {
                    statusEl.innerText = "Verified: Inside Office";
                    statusEl.className = "font-bold text-sm text-green-300";
                    iconEl.innerHTML = '<i class="fas fa-check text-green-600"></i>';
                } else {
                    statusEl.innerText = `Outside (${Math.round(dist)}m)`;
                    statusEl.className = "font-bold text-sm text-red-300";
                    iconEl.innerHTML = '<i class="fas fa-times text-red-600"></i>';
                }
            }, err => console.error(err), options);
        }

        // --- MAIN ACTION: BIOMETRIC + SELFIE + GEOFENCE ---
        window.triggerBiometric = async (type) => {
            if (!currentUser) return;
            if (!userLocation && isOnline) { alert("Waiting for location... Please allow GPS."); return; }

            // Wake up Audio
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const wakeUp = new SpeechSynthesisUtterance(" ");
                window.speechSynthesis.speak(wakeUp);
            }

            // Geo-Fencing
            if (isOnline) {
                const dist = getDist(userLocation.lat, userLocation.lng, OFFICE_LAT, OFFICE_LNG);
                if (dist > ALLOWED_RADIUS) {
                    alert(`ACCESS DENIED!\nYou are ${Math.round(dist)} meters away from office.\nPlease go inside office to punch.`);
                    return; 
                }
            }

            document.getElementById('btn-in').classList.add('hidden');
            document.getElementById('btn-out').classList.add('hidden');
            document.getElementById('btn-loading').classList.remove('hidden');
            document.getElementById('btn-loading').innerText = "Processing...";

            const selfieData = await captureSelfie();

            try {
                if (window.PublicKeyCredential) {
                    const publicKey = {
                        challenge: new Uint8Array([1,2,3,4]),
                        rp: { name: "Oswal" },
                        user: { id: new Uint8Array(16), name: currentUser.email, displayName: currentUserName },
                        pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                        timeout: 60000,
                        authenticatorSelection: { authenticatorAttachment: "platform", userVerification: "required" }
                    };
                    await navigator.credentials.create({ publicKey });
                }
                await saveAttendance(type, selfieData);
            } catch (err) { 
                console.error(err);
                alert("Cancelled or Failed.");
                updateUIBasedOnLastPunch();
            }
        };

        async function saveAttendance(type, selfieData) {
            const record = {
                userId: currentUser.uid,
                userName: currentUserName,
                type: type,
                timestamp: Timestamp.now(),
                location: userLocation || {lat: 0, lng: 0},
                device: navigator.userAgent,
                photo: selfieData || "No Photo",
                status: isOnline ? 'Verified' : 'Offline-Sync-Pending'
            };

            if (isOnline) {
                try {
                    await addDoc(collection(db, "attendance"), record);
                    triggerSuccessAnimation(type); 
                    loadLogs();
                    updateUIBasedOnLastPunch(); 
                } catch (e) { saveOffline(record); }
            } else { saveOffline(record); }
        }

        function triggerSuccessAnimation(type) {
            const flash = document.getElementById('success-flash');
            const msgEl = document.getElementById('success-msg'); 
            flash.classList.remove('hidden');

            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const msg = new SpeechSynthesisUtterance();
                
                // --- CUSTOM VOICE LOGIC (PRESERVED) ---
                if (type === 'Check-In') {
                    msg.text = `Welcome Mr. ${currentUserName} Give Your Best  `;
                    if(msgEl) msgEl.innerText = "Welcome, Good Morning!";
                } else if (type === 'Check-Out') {
                    msg.text = `Bye Mr. ${currentUserName} See you! `;
                    if(msgEl) msgEl.innerText = "Goodbye, See you!";
                } else {
                    msg.text = `Attendance Marked`;
                }
                
                msg.volume = 1; 
                msg.rate = 1;   
                window.speechSynthesis.speak(msg);
            }

            setTimeout(() => { 
                flash.classList.add('hidden'); 
                if(msgEl) msgEl.innerText = "Attendance Marked"; 
            }, 2000);
        }

        function saveOffline(record) {
            record.timestamp = { seconds: record.timestamp.seconds, nanoseconds: record.timestamp.nanoseconds };
            let offlineData = JSON.parse(localStorage.getItem('oswal_offline_punches') || "[]");
            offlineData.push(record);
            localStorage.setItem('oswal_offline_punches', JSON.stringify(offlineData));
            triggerSuccessAnimation(record.type);
            checkOfflineQueue();
        }

        async function syncOfflineData() {
            let offlineData = JSON.parse(localStorage.getItem('oswal_offline_punches') || "[]");
            if (offlineData.length === 0) return;
            document.getElementById('sync-alert').classList.remove('hidden');
            const newQueue = [];
            for (let rec of offlineData) {
                try {
                    rec.timestamp = new Timestamp(rec.timestamp.seconds, rec.timestamp.nanoseconds);
                    rec.status = "Synced-From-Offline";
                    await addDoc(collection(db, "attendance"), rec);
                } catch (e) { newQueue.push(rec); }
            }
            localStorage.setItem('oswal_offline_punches', JSON.stringify(newQueue));
            if (newQueue.length === 0) { 
                loadLogs(); 
                checkOfflineQueue(); 
                updateUIBasedOnLastPunch(); 
            }
        }

        function checkOfflineQueue() {
            let offlineData = JSON.parse(localStorage.getItem('oswal_offline_punches') || "[]");
            if(offlineData.length > 0) document.getElementById('sync-alert').classList.remove('hidden');
            else document.getElementById('sync-alert').classList.add('hidden');
        }

        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const a = 0.5 - Math.cos((lat2-lat1)*Math.PI/180)/2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180) * (1-Math.cos((lon2-lon1)*Math.PI/180))/2;
            return R * 2 * Math.asin(Math.sqrt(a));
        }

        async function loadLogs() {
            if (!isOnline) return;
            const list = document.getElementById('activity-log');
            list.innerHTML = '';
            const today = new Date(); today.setHours(0,0,0,0);
            const q = query(collection(db, "attendance"), where("userId", "==", currentUser.uid), where("timestamp", ">=", Timestamp.fromDate(today)), orderBy("timestamp", "desc"));
            try {
                const snaps = await getDocs(q);
                if(snaps.empty) list.innerHTML = '<p class="text-gray-400 text-center text-sm">No records today.</p>';
                snaps.forEach(doc => {
                    const d = doc.data();
                    const time = d.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    const isCheckIn = d.type === 'Check-In';
                    list.innerHTML += `
                        <li class="flex items-center justify-between border-b border-gray-100 pb-2">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full ${isCheckIn?'bg-green-100':'bg-red-100'} flex items-center justify-center mr-3">
                                    <i class="fas ${isCheckIn?'fa-arrow-right':'fa-arrow-left'} ${isCheckIn?'text-green-600':'text-red-600'}"></i>
                                </div>
                                <div><p class="font-bold text-gray-800">${d.type}</p><p class="text-xs text-gray-500">${d.status || 'Verified'}</p></div>
                            </div>
                            <span class="font-bold text-gray-600">${time}</span>
                        </li>`;
                });
            } catch(e) { console.log(e); }
        }

        // --- NEW: NOTIFICATION SYSTEM LOGIC ---
       // --- IMPROVED NOTIFICATION SYSTEM ---

        // 1. Permission & Setup
        window.requestNotificationPermission = async () => {
            if (!("Notification" in window)) {
                alert("This browser does not support notifications.");
                return;
            }
            const permission = await Notification.requestPermission();
            if (permission === "granted") {
                alert("Notifications Enabled! You will get alerts.");
                document.getElementById('btn-allow-notif').classList.add('hidden');
                
                // Turant ek test bhejo confirmation ke liye
                testNotification();
            } else {
                alert("Permission Denied. Please enable in Settings.");
            }
        };

        function checkNotificationPermission() {
            if ("Notification" in window && Notification.permission !== "granted") {
                document.getElementById('btn-allow-notif').classList.remove('hidden');
            } else {
                document.getElementById('btn-allow-notif').classList.add('hidden');
            }
        }

        // 2. FORCE NOTIFICATION (Service Worker ke through)
        window.testNotification = () => {
            sendForceNotification("Test Successful!", "Your Notification System is working.");
        };

        function sendForceNotification(title, body) {
            // A. Service Worker Notification (Powerful)
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.ready.then(function(registration) {
                    registration.showNotification(title, {
                        body: body,
                        icon: "https://cdn-icons-png.flaticon.com/512/2921/2921226.png",
                        vibrate: [200, 100, 200, 100, 200],
                        tag: 'oswal-alert', // Overwrite old notification
                        requireInteraction: true // User ko dismiss karna padega
                    });
                });
            } 
            // B. Fallback (Simple)
            else {
                new Notification(title, { body: body, icon: "https://cdn-icons-png.flaticon.com/512/2921/2921226.png" });
            }
            
            // In-App Panel me bhi add karein
            addNotification(title + " - " + body);
        }

        // 3. SCHEDULER ENGINE (Har Minute Check Karega)
        function startNotificationScheduler() {
            // Check every 30 seconds to be sure
            setInterval(() => {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const currentTime = `${hours}:${minutes}`;
                
                // Last run check karein taki 1 minute me 10 bar na baje
                const lastRun = localStorage.getItem('last_notif_time');

                const triggers = {
                    "07:50": "Good Morning! Please Mark Attendance & Enter.",
                    "08:00": "Attention! Office Time. Mark Attendance Now.",
                    "08:15": "Late Warning: Please Mark Attendance.",
                    "08:20": "You are Late. Mark Attendance Immediately.",
                    "09:00": "Final Call for Attendance.",
                    "19:50": "Good Evening! Mark Attendance to Exit.",
                    "20:00": "Office Closed. Mark Attendance & Exit.",
                    "20:10": "Overtime? Don't forget to Punch Out."
                };

                if (triggers[currentTime] && lastRun !== currentTime) {
                    // Send Alert
                    sendForceNotification("Attendance Alert â°", triggers[currentTime]);
                    
                    // Save Time
                    localStorage.setItem('last_notif_time', currentTime);
                }

            }, 30000); // 30 Seconds Interval
        }

        // 4. Panel Logic
        function addNotification(msg) {
            const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            let list = JSON.parse(localStorage.getItem('oswal_notifications') || "[]");
            list.unshift({ message: msg, time: time, id: Date.now() });
            if(list.length > 20) list.pop();
            localStorage.setItem('oswal_notifications', JSON.stringify(list));
            updateNotificationUI();
            
            // Badge Logic
            const badge = document.getElementById('notif-badge');
            badge.classList.remove('hidden');
            badge.innerText = "!";
            document.getElementById('bell-icon').classList.add('bell-shake');
            setTimeout(()=> document.getElementById('bell-icon').classList.remove('bell-shake'), 500);
        }

        function updateNotificationUI() {
            const listEl = document.getElementById('notif-list');
            let list = JSON.parse(localStorage.getItem('oswal_notifications') || "[]");
            listEl.innerHTML = '';
            if(list.length === 0) {
                listEl.innerHTML = '<li class="text-center text-gray-400 text-sm mt-10">No new notifications</li>';
            } else {
                list.forEach(n => {
                    listEl.innerHTML += `<li class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500 mb-2"><p class="text-sm font-bold text-gray-800">${n.message}</p><p class="text-xs text-gray-500 mt-1">${n.time}</p></li>`;
                });
            }
        }
        
        window.toggleNotifPanel = () => {
            const panel = document.getElementById('notif-panel');
            panel.classList.toggle('hidden');
            if(!panel.classList.contains('hidden')) {
                document.getElementById('notif-badge').classList.add('hidden');
            }
        };
        window.clearNotifications = () => {
            localStorage.removeItem('oswal_notifications');
            updateNotificationUI();
        };
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then((registration) => {
                    
                    // 1. Jaise hi app khule, turant update check karo
                    registration.update();

                    // 2. Agar update mil gaya (Waiting state me hai)
                    if (registration.waiting) {
                        invokeUpdate(registration);
                    }

                    // 3. Agar naya update install ho raha hai
                    registration.onupdatefound = () => {
                        const newWorker = registration.installing;
                        newWorker.onstatechange = () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                invokeUpdate(registration);
                            }
                        };
                    };
                });
            });

            // Update function
            function invokeUpdate(registration) {
                if (confirm("New Version Available! ðŸš€\nClick OK to Update App.")) {
                    if (registration.waiting) {
                        // Naye worker ko message bhejo skipWaiting ke liye
                        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                    }
                }
            }

            // Reload when new worker takes control
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    window.location.reload();
                    refreshing = true;
                }
            });
        }
    </script>
</body>
</html>
