<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="form-style.css">
   
</head>
<body>
    <div class="header">
        
                <h1 style="text-align: center;">OSWAL LUMBERS PVT LTD </h1>
 
            </div>
                  
    <div class="container dashboard-container">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
            <h1>Invoice Dashboard</h1>
            <div class="d-flex gap-2">
                <button class="btn btn-danger" id="logoutBtn">Logout</button>   
                <button id="import-btn" class="btn btn-success"><i class="fas fa-file-excel"></i> Import from Excel</button>
                <a href="index.html" class="btn btn-primary"><i class="fas fa-plus"></i> Create New Invoice</a>
                <input type="file" id="import-file-input" accept=".xlsx, .xls" style="display: none;">
            </div>
        </div>
        
        <div class="table-responsive">
            <table id="invoice-list" class="table table-striped table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Invoice No</th>
                        <th>Date</th>
                        <th>Buyer</th>
                        <th>Total Amount (US$)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-init.js"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

 <script>
    document.addEventListener('DOMContentLoaded', function() {
        const tbody = document.querySelector('#invoice-list tbody');
        const importBtn = document.getElementById('import-btn');
        const importFileInput = document.getElementById('import-file-input');

        // --- Load existing invoices ---
        db.collection('invoices').orderBy('createdAt', 'desc').get().then(querySnapshot => {
            if (querySnapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No invoices found.</td></tr>';
            }
            querySnapshot.forEach(doc => {
                const invoice = doc.data();
                const row = document.createElement('tr');
                
                // --- THIS LOGIC IS NOW UPDATED ---
                const buyerName = invoice.buyerName || (invoice.buyerDetails ? invoice.buyerDetails.split('\n')[0] : 'N/A');
                
                row.innerHTML = `
                    <td>${invoice.invoiceNo}</td>
                    <td>${new Date(invoice.invoiceDate).toLocaleDateString('en-GB')}</td>
                    <td>${buyerName}</td>
                    <td>${(invoice.totalAmount || 0).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewInvoice('${doc.id}')" title="View"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-warning" onclick="editInvoice('${doc.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteInvoice('${doc.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        });

        // --- Import Logic (and other functions) remain the same ---
        importBtn.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', handleFileImport);
    });

    function handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array', cellDates:true });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            
            try {
                const invoiceData = parseExcelData(worksheet);
                if (invoiceData) { // Check if parsing was successful
                    saveImportedInvoice(invoiceData);
                }
            } catch (error) {
                alert('Critical error parsing Excel file. Please ensure it matches the template format.\n\nError: ' + error.message);
                console.error(error);
            }
        };
        reader.readAsArrayBuffer(file);
        event.target.value = '';
    }

    // ===== NEW: Helper function to safely parse numbers =====
    function safeParseFloat(value) {
        if (typeof value === 'number') return value;
        if (typeof value === 'string') {
            // Remove currency symbols, commas, and trim whitespace
            const cleanedValue = value.replace(/[^0-9.-]+/g,"");
            return parseFloat(cleanedValue) || 0;
        }
        return 0;
    }

    // ===== NEW: Helper function to safely parse dates =====
    function parseDate(excelDate) {
        if (!excelDate) return new Date().toISOString().split('T')[0]; // Default to today if empty
        if (excelDate instanceof Date) {
            return excelDate.toISOString().split('T')[0];
        }
        // If it's a number (Excel's date format), SheetJS with cellDates:true should handle it.
        // If it's a string, try parsing it.
        const d = new Date(excelDate);
        if (!isNaN(d.getTime())) {
            return d.toISOString().split('T')[0];
        }
        // Fallback for unrecognized formats
        console.warn("Unrecognized date format:", excelDate);
        return new Date().toISOString().split('T')[0];
    }

    // ===== UPDATED: More robust parsing logic =====
    function parseExcelData(ws) {
        const get = (addr) => ws[addr] ? ws[addr].v : '';
        
        const invoiceNo = get('H6');
        if (!invoiceNo) {
            alert('Parsing Error: Invoice Number not found in cell H6. Please check your file.');
            return null;
        }

        const sellerDetails = [get('A6'), get('A7'), get('A8'), get('A9'), get('A10'), get('A11'), get('A12')].filter(Boolean).join('\n');
        const buyerDetails = [get('A13'), get('A14'), get('A15'), get('A16')].filter(Boolean).join('\n');
        const invoiceDate = parseDate(get('H7'));

        const items = [];
        let totalAmount = 0;
        for (let i = 19; i < 28; i++) {
            const sno = get(`A${i}`);
            if (!sno) break; 
            
            const itemAmount = safeParseFloat(get(`H${i}`));
            items.push({
                sno: sno,
                desc: get(`B${i}`),
                hsn: get(`C${i}`),
                qty: safeParseFloat(get(`D${i}`)),
                uom: get(`E${i}`),
                m3: safeParseFloat(get(`F${i}`)),
                rate: safeParseFloat(get(`G${i}`)),
                amount: itemAmount
            });
            totalAmount += itemAmount;
        }

        const invoiceObject = {
            sellerDetails: sellerDetails,
            buyerDetails: buyerDetails,
            invoiceNo: invoiceNo,
            invoiceDate: invoiceDate,
            terms: get('H8'),
            portLoading: get('H9'),
            portDischarge: get('H10'),
            countryOrigin: get('H11'),
            containerNo: get('A28') || '',
            containerSize: get('A29') || '',
            totalItems: get('A30') || '',
            grossWeight: get('A32') || '',
            netWeight: get('A33') || '',
            bankDetails: [get('E31'), get('E32'), get('E33'), get('E34')].filter(Boolean).join('\n'),
            remarks: '',
            totalAmount: totalAmount,
            items: items,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        return invoiceObject;
    }

    async function saveImportedInvoice(invoiceData) {
        try {
            await db.collection('invoices').add(invoiceData);
            await updateInvoiceCounter(invoiceData.invoiceNo);
            alert(`Invoice ${invoiceData.invoiceNo} imported successfully!`);
            location.reload();
        } catch (error) {
            alert('Error saving the imported invoice.');
            console.error("Error adding document: ", error);
        }
    }

    async function updateInvoiceCounter(importedInvoiceNo) {
        const match = importedInvoiceNo.match(/EXP\/(\d+)\/\d+/);
        if (!match) return;

        const importedNumber = parseInt(match[1], 10);
        const settingsRef = db.collection('settings').doc('invoiceCounter');

        await db.runTransaction(async (transaction) => {
            const doc = await transaction.get(settingsRef);
            const nextInvoiceNumber = doc.exists ? doc.data().nextInvoiceNumber : 1;
            
            if (importedNumber >= nextInvoiceNumber) {
                transaction.set(settingsRef, { nextInvoiceNumber: importedNumber + 1 }, { merge: true });
                console.log(`Invoice counter updated to ${importedNumber + 1}.`);
            }
        });
    }
    
    function viewInvoice(id) { window.location.href = `view.html?id=${id}`; }
    function editInvoice(id) { window.location.href = `index.html?id=${id}`; }
    function deleteInvoice(id) {
        if (confirm('Are you sure you want to delete this invoice?')) {
            db.collection('invoices').doc(id).delete().then(() => {
                alert('Invoice deleted!');
                location.reload();
            }).catch(error => console.error("Error removing document: ", error));
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
            // Security Check: If not logged in, redirect to login page
            if (sessionStorage.getItem('loggedIn') !== 'true') {
                window.location.href = 'login.html';
            }

            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.addEventListener('click', function() {
                // Remove the login flag
                sessionStorage.removeItem('loggedIn');
                // Redirect to the login page
                window.location.href = 'login.html';
            });
        });
</script>
</body>
</html>